<html><head><title>javascript-example-grid-game-unit-movement</title></head><body> 

<div id="canvas-app"style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>var utils={};utils.angleToPoint=function(x1,y1,x2,y2,scale){scale=scale===undefined?Math.PI*2:scale;var aTan=Math.atan2(y1-y2,x1-x2);return(aTan+Math.PI)/(Math.PI*2)*scale};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect();console.log(e.type,e.touches);return{x:(e.touches?e.touches[0].clientX:e.clientX)-bx.left,y:(e.touches?e.touches[0].clientY:e.clientY)-bx.top,bx:bx}};var mapMod=function(){var createCells=function(map){var cells=[];var len=map.w*map.h,i=0;while(i<len){cells.push({i:i,x:i%map.w,y:Math.floor(i/map.w),unit:false});i+=1}return cells};var api={};api.create=function(opt){opt=opt||{};var map={w:opt.w||9,h:opt.h||7,cellSize:32,margin:{x:opt.marginX==undefined?5:opt.marginX,y:opt.marginY==undefined?5:opt.marginY},cells:[]};map.cells=createCells(map);return map};api.get=function(map,x,y){if(x<0||y<0||x>=map.w||y>=map.h){return false}return map.cells[y*map.w+x]};api.getCellByPointer=function(map,x,y){var cx=Math.floor((x-map.margin.x)/map.cellSize),cy=Math.floor((y-map.margin.y)/map.cellSize);return api.get(map,cx,cy)};return api}();var gameMod=function(){var createBaseUnit=function(){return{HP:100,maxHP:100,weaponIndex:0,sheetIndex:1,currentCell:false,active:false}};var createPlayerUnit=function(){var player=createBaseUnit();player.active=true;player.sheetIndex=0;return player};var placeUnit=function(game,unit,x,y){var map=game.maps[game.mapIndex];var newCell=mapMod.get(map,x,y);if(newCell){if(unit.currentCell){map.cells[unit.currentCell.i].unit=false}unit.currentCell=newCell;map.cells[unit.currentCell.i].unit=unit}};var setupGame=function(game){game.mapIndex=0;var map=game.maps[game.mapIndex];placeUnit(game,game.player,0,0)};var api={};api.create=function(opt){opt=opt||{};var game={mode:"map",maps:[],mapIndex:0,targetCell:false,player:createPlayerUnit()};game.maps.push(mapMod.create({marginX:opt.marginX===undefined?32:opt.marginX,marginY:opt.marginY===undefined?32:opt.marginY,w:opt.w===undefined?4:opt.w,h:opt.h===undefined?4:opt.h}));setupGame(game);return game};api.update=function(game,secs){var cell,radian,target;if(target=game.targetCell){cell=game.player.currentCell;if(target!=cell){radian=utils.angleToPoint(cell.x,cell.y,target.x,target.y);var cx=Math.round(cell.x+Math.cos(radian)),cy=Math.round(cell.y+Math.sin(radian));placeUnit(game,game.player,cx,cy);game.targetCell=false}}};return api}();var draw=function(){var unitColors=["blue","red"];return{back:function(sm){var canvas=sm.canvas,ctx=sm.ctx;ctx.fillStyle="black";ctx.fillRect(0,0,canvas.width,canvas.height)},map:function(sm){var canvas=sm.canvas,ctx=sm.ctx,map=sm.game.maps[sm.game.mapIndex];var cs=map.cellSize,i=0,x,y,len=map.cells.length,cell;while(i<len){cell=map.cells[i];x=map.margin.x+cell.x*cs;y=map.margin.y+cell.y*cs;ctx.fillStyle="green";ctx.beginPath();ctx.rect(x,y,32,32);ctx.fill();ctx.stroke();if(cell.unit){ctx.fillStyle=unitColors[cell.unit.sheetIndex];ctx.beginPath();ctx.rect(x,y,32,32);ctx.fill();ctx.stroke()}i+=1}},info:function(sm){var ctx=sm.ctx,canvas=sm.canvas;ctx.fillStyle="white";ctx.font="10px courier";ctx.textBaseline="top";var pos=sm.input.pos;ctx.fillText("down: "+sm.input.pointerDown+" pos: "+pos.x+","+pos.y,5,5);var p=sm.game.player;ctx.fillText("player pos: "+p.currentCell.x+","+p.currentCell.y,5,15);ctx.fillText("v"+sm.ver,1,canvas.height-11)}}}();(function(){var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),container=document.getElementById("canvas-app")||document.body;container.appendChild(canvas);canvas.width=320;canvas.height=240;ctx.translate(.5,.5);canvas.onselectstart=function(){return false};var sm={ver:"0.1.0",game:gameMod.create({marginX:14,marginY:7,w:9,h:7}),canvas:canvas,ctx:ctx,input:{pointerDown:false,pos:{x:0,y:0}}};var pointerHanders={start:function(sm,e){if(e.type==="touchstart"){e.preventDefault()}sm.input.pos=utils.getCanvasRelative(e);var pos=sm.input.pos;sm.input.pointerDown=true;var cell=mapMod.getCellByPointer(sm.game.maps[sm.game.mapIndex],pos.x,pos.y);if(cell){sm.game.targetCell=cell}},move:function(sm,e){sm.input.pos=utils.getCanvasRelative(e)},end:function(sm,e){sm.input.pointerDown=false}};var createPointerHandler=function(sm,type){return function(e){pointerHanders[type](sm,e)}};canvas.addEventListener("touchstart",createPointerHandler(sm,"start"));canvas.addEventListener("touchmove",createPointerHandler(sm,"move"));canvas.addEventListener("touchend",createPointerHandler(sm,"end"));canvas.addEventListener("mousedown",createPointerHandler(sm,"start"));canvas.addEventListener("mousemove",createPointerHandler(sm,"move"));canvas.addEventListener("mouseup",createPointerHandler(sm,"end"));var loop=function(){requestAnimationFrame(loop);gameMod.update(sm.game);draw.back(sm);draw.map(sm);draw.info(sm)};loop()})();
</script>

</body></html>