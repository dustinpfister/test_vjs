<html><head><title>javascript-example-grid-game-unit-movement</title></head><body> 

<div id="canvas-app"style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>var utils={};utils.valueByRange=function(per,nMin,nMax){per=per===undefined?0:per;nMin=nMin===undefined?0:nMin;nMax=nMax===undefined?1:nMax;return nMin+Math.round(per*(nMax-nMin))};utils.boundingBox=function(x1,y1,w1,h1,x2,y2,w2,h2){return!(y1+h1<y2||y1>y2+h2||x1+w1<x2||x1>x2+w2)};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.angleToPoint=function(x1,y1,x2,y2,scale){scale=scale===undefined?Math.PI*2:scale;var aTan=Math.atan2(y1-y2,x1-x2);return(aTan+Math.PI)/(Math.PI*2)*scale};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect(),pos={x:Math.floor((e.touches?e.touches[0].clientX:e.clientX)-bx.left),y:Math.floor((e.touches?e.touches[0].clientY:e.clientY)-bx.top),bx:bx};pos.x=Math.floor(pos.x/canvas.scrollWidth*canvas.width);pos.y=Math.floor(pos.y/canvas.scrollHeight*canvas.height);return pos};utils.deepCloneJSON=function(obj){try{return JSON.parse(JSON.stringify(obj))}catch(e){return{}}};utils.getPath=function(sourceObj,pathStr,def){var propNames=pathStr.split(".");var node=sourceObj[propNames[0]];var i=1,len=propNames.length;while(i<len){try{node=node[propNames[i]];if(node===undefined){return def}}catch(e){return def}i+=1}return node};utils.setPath=function(sourceObj,pathStr,value){var propNames=pathStr.split(".");var i=0,len=propNames.length,node=sourceObj,tNode;while(i<len){try{if(i===len-1){node[propNames[i]]=value}else{tNode=node[propNames[i]];if(tNode===undefined){tNode=node[propNames[i]]={}}if(typeof tNode!="object"||tNode===null){return new Error("Property "+propNames[i]+" is not an object or is null.")}node=tNode}}catch(e){return e}i+=1}return{}};utils.log=function(mess,type){type=type||"info";if(type==="info"){console.log(mess);return}if(type==="debug"){console.log(mess);return}console.warn(mess)};utils.http=function(opt){var opt=opt||{};opt.url=opt.url||"";opt.method=opt.method||"GET";opt.async=opt.async===undefined?true:opt.async;opt.body=opt.body===undefined?null:opt.body;opt.onDone=opt.onDone||utils.noop;opt.onError=opt.onError||utils.noop;opt.responseType=opt.responseType||"";var xhr=new XMLHttpRequest;xhr.responseType=opt.responseType;xhr.open(opt.method,opt.url,opt.async);xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status>=200&&xhr.status<400){opt.onDone.call(xhr,xhr.response,xhr)}else{opt.onError.call(xhr,xhr)}}};xhr.send(opt.body)};utils.XP=function(){var default_deltaNext=50,defualt_cap=100;var getLevel=function(xp,deltaNext){deltaNext=deltaNext===undefined?default_deltaNext:deltaNext;return(1+Math.sqrt(1+8*xp/deltaNext))/2};var getXP=function(level,deltaNext){deltaNext=deltaNext===undefined?default_deltaNext:deltaNext;return(Math.pow(level,2)-level)*deltaNext/2};var parseByXP=function(xp,cap,deltaNext){var l=getLevel(xp,deltaNext);l=l>cap?cap:l;var level=Math.floor(l),forNext=getXP(level+1,deltaNext);return{level:level,levelFrac:l,per:l%1,xp:xp,forNext:l===cap?Infinity:forNext,toNext:l===cap?Infinity:forNext-xp}};return{parseByLevel:function(l,cap,deltaNext){return parseByXP(getXP(l,deltaNext),cap,deltaNext)},parseByXP:parseByXP}}();var poolMod=function(){var api={};var getInactive=function(pool){var i=pool.objects.length,obj;while(i--){obj=pool.objects[i];if(!obj.active){return obj}}return false};api.create=function(opt){opt=opt||{};opt.count=opt.count||10;var i=0,pool={objects:[],secsCap:opt.secsCap===undefined?Infinity:opt.secsCap,disableLifespan:opt.disableLifespan||false,data:opt.data||{},spawn:opt.spawn||function(obj,pool,state,opt){},purge:opt.purge||function(obj,pool,state){},update:opt.update||function(obj,pool,state,secs){}};while(i<opt.count){pool.objects.push({active:false,i:i,x:opt.x===undefined?0:opt.x,y:opt.y===undefined?0:opt.y,w:opt.w===undefined?32:opt.w,h:opt.h===undefined?32:opt.h,heading:opt.heading===undefined?0:opt.heading,pps:opt.pps===undefined?32:opt.pps,lifespan:opt.lifespan||3,data:{}});i+=1}return pool};api.spawn=function(pool,state,opt){var obj=getInactive(pool);state=state||{};opt=opt||{};if(obj){if(!obj.active){obj.active=true;pool.spawn.call(pool,obj,pool,state,opt);return obj}}return false};api.spawnAll=function(pool,state,opt){pool.objects.forEach(function(obj){if(!obj.active){obj.active=true;pool.spawn.call(pool,obj,pool,state,opt);return obj}});return pool.objects};api.purge=function(pool,obj,state){obj.active=false;pool.purge.call(pool,obj,pool,state)};api.purgeAll=function(pool,state,opt){pool.objects.forEach(function(obj){if(!obj.active){obj.active=false;pool.purge.call(pool,obj,pool,state)}});return pool.objects};api.update=function(pool,secs,state){var i=pool.objects.length,obj;state=state||{};secs=secs>pool.secsCap?pool.secsCap:secs;while(i--){obj=pool.objects[i];if(obj.active){pool.update.call(pool,obj,pool,state,secs);if(pool.disableLifespan){}else{obj.lifespan-=secs;obj.lifespan=obj.lifespan<0?0:obj.lifespan;if(obj.lifespan===0){obj.active=false;api.purge.call(pool,pool,obj,state)}}}}};api.setActiveStateForAll=function(pool,bool){bool=bool===undefined?false:bool;var i=pool.objects.length,obj;while(i--){obj=pool.objects[i];obj.active=bool}};api.moveByPPS=function(obj,secs){obj.x+=Math.cos(obj.heading)*obj.pps*secs;obj.y+=Math.sin(obj.heading)*obj.pps*secs};api.checkBounds=function(obj,canvas){if(obj.x>=canvas.width||obj.x<obj.w*-1||obj.y>canvas.height||obj.y<obj.h*-1){return false}return true};api.boundingBox=function(a,b){return utils.boundingBox(a.x,a.y,a.w,a.h,b.x,b.y,b.w,b.h)};api.wrap=function(obj,area,space){area=area||{x:0,y:0,width:640,height:480};space=space===undefined?32:space;if(!utils.boundingBox(obj.x,obj.y,obj.w,obj.h,space*-1,space*-1,area.width+space,area.height+space)){obj.x=utils.mod(obj.x+space,area.width+space*2)-space;obj.y=utils.mod(obj.y+space,area.height+space*2)-space}};api.getOverlaping=function(obj,pool){var i=0,obj2,overlap=[];len=pool.objects.length;if(obj.active){while(i<len){obj2=pool.objects[i];if(obj!=obj2&&obj2.active){if(utils.boundingBox(obj.x,obj.y,obj.w,obj.h,obj2.x,obj2.y,obj2.w,obj2.h)){overlap.push(obj2)}}i+=1}}return overlap};api.getActiveCount=function(pool){return pool.objects.reduce(function(acc,obj){return obj.active?acc+=1:acc},0)};api.getActiveObjects=function(pool){return pool.objects.reduce(function(acc,obj){if(obj.active){acc.push(obj)}return acc},[])};api.getDistanceToObj=function(obj1,obj2){var x1=obj2.x+obj2.w/2,y1=obj2.y+obj2.h/2,x2=obj1.x+obj1.w/2,y2=obj1.y+obj1.h/2;return utils.distance(x1,y1,x2,y2)};return api}();var unitMod=function(){var LEVEL_CAP=100,LEVEL_DELTA_NEXT=50;var api={};var ITEMS={};ITEMS.weapon={};ITEMS.weapon.melee={};ITEMS.weapon.melee.sword={perLevel:{baseAttack:{min:[1,1],inc:[1,.5]}}};var setStat={};setStat.attack=function(unit){unit.attack=unit.baseAttack.map(function(ba,i){var cw=unit.currentWeapon!=null?unit.currentWeapon.attack[i]:0;return ba+cw})};setStat.baseAttack=function(unit,l,baOpt){var ba=unit.baseAttack=[0,0];if(baOpt){ba[0]=baOpt.min[0]+Math.floor(baOpt.inc[0]*l);ba[1]=ba[0]+baOpt.min[1]+Math.floor(baOpt.inc[1]*l)}};setStat.baseDefense=function(unit,l,bdOpt){var bd=unit.baseDefense=[0,0];if(bdOpt){bd[0]=bdOpt.min[0]+Math.floor(bdOpt.inc[0]*l);bd[1]=bd[0]+bdOpt.min[1]+Math.floor(bdOpt.inc[1]*l)}};var setUnitStats=function(unit){var level=unit.levelObj.level,perLevel=unit.perLevel,l=level-1;unit.maxHP=30+15*l;setStat.baseAttack(unit,l,perLevel.baseAttack);setStat.baseDefense(unit,l,perLevel.baseDefense);setStat.attack(unit)};var createBaseUnit=function(){var unit={levelObj:utils.XP.parseByLevel(1,LEVEL_CAP,LEVEL_DELTA_NEXT),perLevel:{},xpValue:25,maxHP:1,maxCellsPerTurn:0,baseAttack:[0,0],baseDefense:[0,0],attack:[0,0],meleeWeapon:null,currentWeapon:null,HP:1,subType:"",data:{},children:[],pouch:[],walkable:false,weaponIndex:0,sheetIndex:0,type:null,meleeTarget:null,moveCells:[],currentCellIndex:null,active:true};return unit};var UNIT_TYPES={};UNIT_TYPES.group={create:function(group,opt){group.sheetIndex=5;group.walkable=true;group.pouch=[];var pouch=opt.pouch;if(pouch){pouch.forEach(function(obj){if(obj.type==="item"){var item=obj;group.pouch.push(item)}else{var itemOpt=obj;group.pouch.push(api.createUnit("item",itemOpt))}})}}};UNIT_TYPES.item={create:function(item,itemOpt){item.sheetIndex=6;item.walkable=true;item.subType=itemOpt.subType;var itemRec=utils.getPath(ITEMS,itemOpt.subType,null);item.levelObj=utils.XP.parseByLevel(itemOpt.level,LEVEL_CAP,LEVEL_DELTA_NEXT);item.perLevel=itemRec.perLevel}};UNIT_TYPES.player={create:function(player){player.levelObj=utils.XP.parseByLevel(1,LEVEL_CAP,LEVEL_DELTA_NEXT);player.maxCellsPerTurn=3;player.sheetIndex=2;player.perLevel={baseAttack:{min:[2,1],inc:[.75,.5]},baseDefense:{min:[1,1],inc:[.125,.025]}};var startItem=api.createUnit("item",{subType:"weapon.melee.sword",level:2});player.pouch.push(startItem);player.currentWeapon=player.pouch[0]}};UNIT_TYPES.enemy={create:function(enemy){enemy.maxCellsPerTurn=2;enemy.sheetIndex=3;var perLevel=enemy.perLevel={};perLevel.baseAttack={min:[2,1],inc:[.25,.125]};enemy.currentWeapon=api.createUnit("item",{subType:"weapon.melee.sword",level:1})}};UNIT_TYPES.wall={create:function(wall){wall.sheetIndex=1}};UNIT_TYPES.portal={create:function(portal){portal.sheetIndex=4;portal.walkable=true;portal.data={}}};api.createUnit=function(type,opt){var unit=createBaseUnit();unit.type=type;UNIT_TYPES[type].create(unit,opt);setUnitStats(unit);return unit};api.giveXP=function(unit,xp){var lObj=unit.levelObj,cXP=lObj.xp;cXP+=xp;unit.levelObj=utils.XP.parseByXP(cXP,LEVEL_CAP,LEVEL_DELTA_NEXT);setUnitStats(unit)};api.meleeAttack=function(attacker,target){setStat.attack(attacker);var fa=attacker.attack,ra=utils.valueByRange(Math.random(),fa[0],fa[1]);var bd=target.baseDefense,d=utils.valueByRange(Math.random(),bd[0],bd[1]);var a=ra-d;a=a<0?0:a;target.HP-=a;target.HP=target.HP<0?0:target.HP};api.loadItems=function(data){utils.log("units.js: loading items from a given data object");var itemKeys=Object.keys(data).filter(function(key){var parts=key.split("_");if(parts.length>=2&&parts[0]==="i"){return true}return false});itemKeys.forEach(function(key){var itemDefs=data[key];itemDefs.items.forEach(function(itemDef){var item=utils.setPath(ITEMS,itemDef.subType,itemDef)})});utils.log("units.js: There are now "+Object.keys(ITEMS.weapon.melee).length+" melee weapons to work with.")};return api}();var mapMod=function(){var createCells=function(map){var cells=[];var len=map.w*map.h,i=0;while(i<len){cells.push({i:i,x:i%map.w,y:Math.floor(i/map.w),walkable:true,closed:false,data:{},unit:null});i+=1}return cells};var api={};api.create=function(opt){opt=opt||{};var map={w:opt.w||9,h:opt.h||7,cellSize:32,margin:{x:opt.marginX==undefined?5:opt.marginX,y:opt.marginY==undefined?5:opt.marginY},cells:[]};map.cells=opt.cells||createCells(map);return map};api.get=function(map,xi,y){if(arguments.length===2){return map.cells[xi]}if(xi<0||y<0||xi>=map.w||y>=map.h){return false}return map.cells[y*map.w+xi]};api.getCellByPointer=function(map,x,y){var cx=Math.floor((x-map.margin.x)/map.cellSize),cy=Math.floor((y-map.margin.y)/map.cellSize);return api.get(map,cx,cy)};var sortOpen=function(opened){return opened.sort(function(nodeA,nodeB){if(nodeA.weight<nodeB.weight){return 1}if(nodeA.weight>nodeB.weight){return-1}return 0})};var setWeight=function(endNode,neighbor){return utils.distance(endNode.x,endNode.y,neighbor.x,neighbor.y)};var buildPath=function(node){var path=[];while(node.parent){path.push([node.x,node.y]);node=node.parent}return path};var forNeighbors=function(grid,node,endNode,opened){var neighbors=mapMod.getNeighbors(grid,node);var ni=0,nl=neighbors.length;while(ni<nl){var neighbor=neighbors[ni];if(neighbor.closed){ni+=1;continue}neighbor.weight=setWeight(endNode,neighbor);if(!neighbor.opened){neighbor.parent=node;opened.push(neighbor);neighbor.opened=true}ni+=1}};api.getPath=function(grid,sx,sy,ex,ey){var grid=utils.deepCloneJSON(grid),nodes=api.chunk(grid),path=[],opened=[],node;var startNode=nodes[sy][sx];endNode=nodes[ey][ex];opened.push(startNode);startNode.opened=true;startNode.weight=0;while(opened.length>0){node=opened.pop();node.closed=true;if(node===endNode){return buildPath(node)}forNeighbors(grid,node,endNode,opened);sortOpen(opened)}return[]};api.chunk=function(grid){var arr=[],row,i=0;while(i<grid.cells.length){row=grid.cells.slice(i,i+grid.w);arr.push(row);i+=grid.w}return arr};api.isInBounds=function(grid,x,y){return x>=0&&x<grid.w&&(y>=0&&y<grid.h)};api.isWalkable=function(grid,x,y){if(api.isInBounds(grid,x,y)){return api.get(grid,x,y).walkable}return false};api.getNeighbors=function(grid,node){var x=node.x,y=node.y,neighbors=[];if(api.isWalkable(grid,x,y-1)){neighbors.push(mapMod.get(grid,x,y-1))}if(api.isWalkable(grid,x,y+1)){neighbors.push(mapMod.get(grid,x,y+1))}if(api.isWalkable(grid,x-1,y)){neighbors.push(mapMod.get(grid,x-1,y))}if(api.isWalkable(grid,x+1,y)){neighbors.push(mapMod.get(grid,x+1,y))}return neighbors};return api}();var gameMod=function(){var MAP_EVENTS={};MAP_EVENTS.hardMapReset=function(game,secs,type,opt){setupGame(game,true)};MAP_EVENTS.softMapReset=function(game,secs,type,opt){setupGame(game,false)};MAP_EVENTS.nothing=function(game,secs,type,opt){utils.log("doing nothing for "+type+" map event in worldMap "+game.worldMap.dataKey,"info");utils.log("at mapIndex: "+game.mapIndex,"info");utils.log("","info")};MAP_EVENTS.toMap=function(game,secs,type,opt){var portalData={mi:0,x:0,y:0,dataKey:opt[0],dmi:parseInt(opt[1]),dx:parseInt(opt[2]),dy:parseInt(opt[3])};changeWorldMap(game,portalData)};MAP_EVENTS.respawnWorldEnemies=function(game,secs,type,opt){setupGame2(game)};var api={};api.VOID_WORLD={dataKey:"wm_void",mapName:"Void World",mapWidth:9,mapHeight:7,mapWorldWidth:3,mapWorldHeight:3,mapStrings:["111111111120000003100000000100000000100000000100000000100000000","111111111000000000000000000000000000000000000000000000000000000","111111111000000001000000001000000001000000001000000001000000001","100000000100000000100000000100000000100000000100000000100000000","000000000000000000000000000000000000000000000000000000000000000","000000001000000001000000001000000001000000001000000001000000001","100000000100000000100000000100000000100000000100000000111111111","000000000000000000000000000000000000000000000000000000111111111","000000001000000001000000001000000001000000001000000001111111111"],mapGroups:[],mapPortals:[],mapWorldUnits:[]};var isAtCorner=function(game,cell){var map=game.maps[game.mapIndex],w=map.w-1,h=map.h-1;return cell.x===0&&cell.y===0||cell.x===w&&cell.y===h||cell.x===0&&cell.y===h||cell.x===w&&cell.y===0};var getToIndexOptions=function(game,x,y,ox,oy){var toIndex=null,dir="",p=game.player,map=game.maps[game.mapIndex],cell=mapMod.get(map,x,y),mww=game.worldMap.mapWorldWidth,mwx=game.mapIndex%mww,mwy=Math.floor(game.mapIndex/mww),options=[];if(isAtCorner(game,cell)){if(x===0&&y===0){return getToIndexOptions(game,0,1,x,y).concat(getToIndexOptions(game,1,0,x,y))}if(x===map.w-1&&y===0){return getToIndexOptions(game,map.w-1,1,x,y).concat(getToIndexOptions(game,map.w-2,0,x,y))}if(x===map.w-1&&y===map.h-1){return getToIndexOptions(game,map.w-1,map.h-2,x,y).concat(getToIndexOptions(game,map.w-2,map.h-1,x,y))}if(x===0&&y===map.h-1){return getToIndexOptions(game,0,map.h-2,x,y).concat(getToIndexOptions(game,map.w-2,map.h-1,x,y))}}else{if(x===0){var x=mwx-1;x=x<0?mww-1:x;toIndex=mwy*mww+x;dir="west"}if(x===map.w-1){var x=mwx+1;x=x>=mww?0:x;toIndex=mwy*mww+x;dir="east"}if(y===0){var y=mwy-1;y=y<0?game.maps.length/mww-1:y;toIndex=y*mww+mwx;dir="north"}if(y===map.h-1){var y=mwy+1;y=y>=game.maps.length/mww?0:y;toIndex=y*mww+mwx;dir="south"}}return dir===""?[]:[{mi:toIndex,dir:dir,x:ox===undefined?x:ox,y:oy===undefined?y:oy}]};var getToMap=function(game){var toMap={index:null,x:null,y:null};var pCell=api.getPlayerCell(game);var map=game.maps[game.mapIndex];var options=toMap.options=getToIndexOptions(game,pCell.x,pCell.y);options=options.map(function(opt){if(opt.dir==="north"){opt.y=map.h-1}if(opt.dir==="south"){opt.y=0}if(opt.dir==="east"){opt.x=0}if(opt.dir==="west"){opt.x=map.w-1}return opt});if(options.length>=1){toMap.index=options[0].mi;toMap.x=options[0].x;toMap.y=options[0].y}return toMap};var getMovePath=function(game,startCell,targetCell){var map=game.maps[game.mapIndex],unit=startCell.unit||null;var path=mapMod.getPath(map,startCell.x,startCell.y,targetCell.x,targetCell.y);if(unit){path=path.reverse().slice(0,unit.maxCellsPerTurn)}return path};var getMoveCells=function(game,startCell,targetCell){var map=game.maps[game.mapIndex];var path=getMovePath(game,startCell,targetCell).map(function(pos){var cell=mapMod.get(map,pos[0],pos[1]);return cell.i});return path};var getEnemeyMoveCells=function(game,eCell){var pCell=api.getPlayerCell(game),map=game.maps[game.mapIndex];var pCellNeighbors=mapMod.getNeighbors(map,pCell).filter(function(cell){return cell.walkable});var mtcOptions=pCellNeighbors.map(function(cell){return getMoveCells(game,eCell,cell)}).filter(function(mtcOptions){return mtcOptions.length>0});return mtcOptions[0]||[]};var placeUnit=function(game,unit,x,y,mi){var map=game.maps[mi===undefined?game.mapIndex:mi];var newCell=mapMod.get(map,x,y);if(newCell){if(unit.currentCellIndex!=null){var oldCell=map.cells[unit.currentCellIndex];oldCell.walkable=true;map.cells[unit.currentCellIndex].unit=null;if(unit.children.type==="group"||unit.children.type==="portal"){oldCell.unit=unit.children;unit.children=[]}}if(newCell.unit){if(newCell.unit.walkable){unit.children=newCell.unit}}newCell.walkable=unit.walkable;unit.currentCellIndex=newCell.i;map.cells[unit.currentCellIndex].unit=unit}};var placePlayer=function(game){var map=game.maps[game.mapIndex],toMap=game.toMap,toCell=null,i=map.cells.length;if(toMap.x!=null&&toMap.y!=null){toCell=mapMod.get(map,toMap.x,toMap.y)}if(toCell){if(!toCell.unit){placeUnit(game,game.player,toCell.x,toCell.y);game.toMap=getToMap(game);return}}while(i--){var cell=map.cells[i];if(cell.unit===null){placeUnit(game,game.player,cell.x,cell.y);game.toMap=getToMap(game);return}}};var moveUnit=function(game,unit){if(unit.moveCells.length>0){var ci=unit.moveCells.shift();var moveToCell=mapMod.get(game.maps[game.mapIndex],ci);if(moveToCell.unit){if(moveToCell.unit.walkable){placeUnit(game,unit,moveToCell.x,moveToCell.y)}}else{placeUnit(game,unit,moveToCell.x,moveToCell.y)}if(unit.type==="player"){game.toMap=getToMap(game);if(unit.children.type==="portal"){var portalUnit=unit.children;unit.children=[];changeWorldMap(game,portalUnit.data)}}}};var getRemainingEnemies=function(game){return game.maps.reduce(function(acc,map){var eCells=getCellsByUnitType(map,"enemy");return acc+eCells.length},0)};var genMapStrings=function(opt){opt=opt||{};opt.mapWorldWidth=opt.mapWorldWidth||1;opt.mapWorldHeight=opt.mapWorldHeight||1;var w=opt.w||9,h=opt.h||7;var strLength=w*h;var blankStr=Array.from({length:strLength}).map(function(){return 0}).join("");var i=0,mapStrings=[],len=opt.mapWorldWidth*opt.mapWorldHeight;while(i<len){mapStrings.push(blankStr);i+=1}var str=mapStrings[0];var arr=str.split("");arr[0]="2";mapStrings[0]=arr.join("");var str=mapStrings[1];var arr=str.split("");arr[7]="3";mapStrings[1]=arr.join("");return mapStrings};var createCleanMaps=function(game){var wMap=game.worldMap;game.maps=[];wMap.mapStrings.forEach(function(){game.maps.push(mapMod.create({marginX:game.marginX,marginY:game.marginY,w:wMap.mapWidth,h:wMap.mapHeight}))})};var applyMapStringsToMaps=function(game,newGame,portal,skipCI){newGame=newGame===undefined?true:newGame;portal=portal===undefined?false:portal;skipCI=skipCI===undefined?{}:skipCI;var wMap=game.worldMap,playerPlaced=false,startMapIndex=false;game.maps=game.maps.map(function(map,mi){var mapStr=wMap.mapStrings[mi]||"";map.cells=map.cells.map(function(cell,ci){var cellIndex=parseInt(mapStr[ci]||"0"),x=ci%map.w,y=Math.floor(ci/map.w);if(cellIndex===0&&newGame&&!skipCI[0]){var cell=mapMod.get(map,ci);cell.unit=null;cell.walkable=true}if(cellIndex===1&&!skipCI[1]){var wall=unitMod.createUnit("wall");placeUnit(game,wall,x,y,mi)}if(cellIndex===2&&!portal&&!skipCI[2]){playerPlaced=true;startMapIndex=mi;placeUnit(game,game.player,x,y,mi)}if(cellIndex===3&&newGame&&!skipCI[3]){var enemy=unitMod.createUnit("enemy");enemy.HP=enemy.maxHP;placeUnit(game,enemy,x,y,mi)}return cell});return map});return{playerPlaced:playerPlaced,startMapIndex:startMapIndex}};var parseMapEvent=function(game,type,defaultMethod){var mapEvent=game.worldMap[type]||defaultMethod||MAP_EVENTS.softMapReset;if(typeof mapEvent==="string"){var arr=mapEvent.split(":"),opt=[];if(arr[1]){opt=arr[1].split(",")}return{type:type,method:MAP_EVENTS[arr[0]],opt:opt}}return{type:type,method:mapEvent,opt:[]}};var callMapEvent=function(game,secs,type,defaultMethod){var mapEventObj=parseMapEvent(game,type,defaultMethod);mapEventObj.method.call(game,game,secs,mapEventObj.type,mapEventObj.opt)};var getCellsByUnitType=function(map,type){return map.cells.reduce(function(acc,cell){if(cell.unit){if(cell.unit.type===type){acc.push(cell)}}return acc},[])};var changeWorldMap=function(game,portalData){callMapEvent(game,0,"onWorldMapLeave",MAP_EVENTS.nothing);var newWorldMap=game.sm.data[portalData.dataKey];game.worldMap=newWorldMap;game.turnState="wait";setupGame(game,true,portalData);callMapEvent(game,0,"onWorldMapEnter",MAP_EVENTS.nothing)};var changeMap=function(game){callMapEvent(game,0,"onMapLeave",MAP_EVENTS.nothing);var pCell=api.getPlayerCell(game);game.mapIndex=game.toMap.index;pCell.unit=null;pCell.walkable=true;game.player.currentCellIndex=null;placePlayer(game);game.toMap=getToMap(game);callMapEvent(game,0,"onMapEnter",MAP_EVENTS.nothing)};var startMenu=function(game,menuKey,opt){opt=opt||{};game.mode="menu";var d=game.options.data;d.menuKey=menuKey||"main";d.mode="enter";d.lines=opt.lines||[];d.activeButton=null;createMenu(game)};var createMapButtonOnClick=function(dir){return function(sm,button){var tm=sm.game.toMap;sm.game.mode="map";tm.options.forEach(function(opt){if(opt.dir===dir){tm.index=opt.mi;tm.x=opt.x;tm.y=opt.y}});changeMap(sm.game)}};var BUTTON={};BUTTON.quit={desc:"quit",outer:true,onClick:function(sm,button){sm.game.options.data.menuKey="main";sm.setState("title")}};BUTTON.resume={desc:"resume",outer:true,onClick:function(sm,button){sm.game.options.data.menuKey="main";sm.game.mode="map"}};BUTTON.to_pickup={desc:"Pick Up",outer:true,onClick:function(sm,button){startMenu(sm.game,"pickup")}};BUTTON.to_main={desc:"Main",outer:true,onClick:function(sm,button){startMenu(sm.game,"main")}};BUTTON.to_pouch={desc:"Pouch",outer:true,onClick:function(sm,button){startMenu(sm.game,"pouch")}};BUTTON.map_south={desc:"South",outer:false,ta:Math.PI*.5,onClick:createMapButtonOnClick("south")};BUTTON.map_north={desc:"North",outer:false,ta:Math.PI*1.5,onClick:createMapButtonOnClick("north")};BUTTON.map_east={desc:"East",outer:false,ta:Math.PI*2,onClick:createMapButtonOnClick("east")};BUTTON.map_west={desc:"West",outer:false,ta:Math.PI*1,onClick:createMapButtonOnClick("west")};var MENUS={};MENUS.main={buttonKeys:function(game){var buttonKeys=["quit","resume","to_pouch"];buttonKeys=buttonKeys.concat(game.toMap.options.map(function(opt){return"map_"+opt.dir}));if(game.player.children.type==="group"){buttonKeys.push("to_pickup")}return buttonKeys},genButtons:function(){var buttons=[];return buttons}};MENUS.pickup={buttonKeys:function(game){var buttonKeys=["to_main"];return buttonKeys},genButtons:function(game){var group=game.player.children;if(group.type==="group"){return group.pouch.map(function(item,i){return{desc:item.subType.split(".")[2]||"item",subText:"lv"+item.levelObj.level,outer:true,onClick:function(sm,button){group.pouch.splice(i,1);game.player.pouch.push(item);if(group.pouch.length===0){game.player.children=[];startMenu(sm.game,"main")}else{startMenu(sm.game,"pickup")}utils.log("item button clicked!","debug");utils.log("groupIndex: "+i+", subType: "+item.subType,"debug");utils.log("player pouch: "+game.player.pouch,"debug");utils.log("group pouch: "+group.pouch,"debug")}}})}return[]}};MENUS.pouch={buttonKeys:function(game){return["to_main"]},genButtons:function(game){return game.player.pouch.map(function(item,i){return{desc:item.subType.split(".")[2]||"item",subText:"lv"+item.levelObj.level,outer:true,onClick:function(sm,button){game.options.data.menuOpt.itemIndex=i;game.options.data.menuOpt.item=item;startMenu(sm.game,"item",{lines:[item.subType]})}}})}};BUTTON.item_drop={desc:"drop",outer:true,onClick:function(sm,button){var game=sm.game,i=game.options.data.menuOpt.itemIndex,item=game.player.pouch[i],itemName=item.subType.split(".")[2];var over=game.player.children;if(over.type==="group"){game.player.pouch.splice(i,1);over.pouch.push(item)}else{if(over.type===undefined){game.player.pouch.splice(i,1);game.player.children=unitMod.createUnit("group",{pouch:[item]})}}if(item===game.player.currentWeapon){game.player.currentWeapon=null}startMenu(sm.game,"pouch")}};BUTTON.item_equip={desc:"equip",outer:true,type:"action",onClick:function(sm,button){var item=sm.game.options.data.menuOpt.item;if(item===sm.game.player.currentWeapon){sm.game.player.currentWeapon=null}else{sm.game.player.currentWeapon=item}}};MENUS.item={buttonKeys:function(game){return["to_pouch","item_drop","item_equip"]},genButtons:function(game){return[]}};var getCollectionKeyValueCount=function(objects,prop,value){return objects.reduce(function(acc,obj){if(obj[prop]===value){acc+=1}return acc},0)};var createButtonDataObjects=function(game){var menuKey=menuPool.data.menuKey,menu=MENUS[menuKey];var buttonDataObjects=menu.buttonKeys(game).map(function(bKey){return BUTTON[bKey]});var genButtons=menu.genButtons(game);buttonDataObjects=buttonDataObjects.concat(genButtons);return buttonDataObjects};var createMenu=function(game){var menuKey=menuPool.data.menuKey;game.options.objects.forEach(function(button){button.active=false});var buttonDataObjects=createButtonDataObjects(game);var oi=0,ii=0,oc=getCollectionKeyValueCount(buttonDataObjects,"outer",true),ic=getCollectionKeyValueCount(buttonDataObjects,"outer",false);buttonDataObjects.forEach(function(buttonDATA){var len=buttonDATA.outer?oc:ic,i=buttonDATA.outer?oi:ii,ta=Math.PI*2/len*(i+1);ta=buttonDATA.ta!=undefined?buttonDATA.ta:ta;poolMod.spawn(game.options,sm,{desc:buttonDATA.desc,subText:buttonDATA.subText,onClick:buttonDATA.onClick,outer:buttonDATA.outer,ta:ta,type:buttonDATA.type});if(buttonDATA.outer){oi+=1}else{ii+=1}})};var menuPool={count:11,w:45,h:45,disableLifespan:true,data:{outerRadius:85,innerRadius:35,outerTotal:1,frame:0,maxFrame:15,activeButton:null,mode:"enter",menuKey:"main",menuOpt:{},lines:[]}};menuPool.spawn=function(button,options,sm,spawnOpt){var bd=button.data,pd=options.data;bd.desc=spawnOpt.desc||false;bd.subText=spawnOpt.subText||"";bd.type=spawnOpt.type||"default";bd.cx=button.x=sm.canvas.width/2-button.w/2;bd.cy=button.y=sm.canvas.height/2-button.h/2;bd.radius=0;bd.a=0;bd.ta=spawnOpt.ta===undefined?Math.PI*2:spawnOpt.ta;bd.outer=spawnOpt.outer===undefined?true:spawnOpt.outer;bd.onClick=spawnOpt.onClick||function(){};pd.frame=0;pd.outerTotal=spawnOpt.outerTotal===undefined?1:spawnOpt.outerTotal};menuPool.update=function(button,options,sm,secs){var pd=options.data,bd=button.data;if(button.i===options.objects.length-1){if(pd.mode==="enter"){pd.frame+=30*secs;pd.frame=pd.frame>=pd.maxFrame?pd.maxFrame:pd.frame;if(pd.frame===pd.maxFrame){pd.mode="wait"}}if(pd.mode==="wait"){if(pd.activeButton){if(pd.activeButton.data.type==="default"){pd.mode="exit"}if(pd.activeButton.data.type==="action"){pd.activeButton.data.onClick.call(sm,sm,pd.activeButton);pd.activeButton=null}}}if(pd.mode==="exit"){pd.frame-=30*secs;pd.frame=pd.frame<0?0:pd.frame;if(pd.frame===0){if(pd.activeButton){pd.activeButton.data.onClick.call(sm,sm,pd.activeButton)}else{pd.menuKey="main";sm.game.mode="map"}}}}var per=pd.frame/pd.maxFrame;var radius=bd.outer?pd.outerRadius:pd.innerRadius;bd.a=bd.ta*per;button.x=bd.cx+Math.cos(bd.a)*radius*per;button.y=bd.cy+Math.sin(bd.a)*radius*per};var setupPortals=function(game){game.worldMap.mapPortals.forEach(function(portal){var portalUnit=unitMod.createUnit("portal");placeUnit(game,portalUnit,portal.x,portal.y,portal.mi);portalUnit.data=portal})};var setupGroups=function(game){game.worldMap.mapGroups.forEach(function(opt){var gUnit=unitMod.createUnit("group",opt);placeUnit(game,gUnit,opt.x,opt.y,opt.mi);gUnit.data={}})};var setupGame2=function(game){var pCell=api.getPlayerCell(game),wMap=game.worldMap;game.maps=game.maps.map(function(map,mi){var mapStr=wMap.mapStrings[mi]||"";map.cells=map.cells.map(function(cell,ci){var cellIndex=parseInt(mapStr[ci]||"0"),x=ci%map.w,y=Math.floor(ci/map.w);if(cellIndex===0){var cell=mapMod.get(map,ci);cell.unit=null;cell.walkable=true}if(cellIndex===1){var wall=unitMod.createUnit("wall");placeUnit(game,wall,x,y,mi)}if(cellIndex===3){var enemy=unitMod.createUnit("enemy");enemy.HP=enemy.maxHP;placeUnit(game,enemy,x,y,mi)}return cell});return map});setupGroups(game);setupPortals(game);game.remainingEnemies=getRemainingEnemies(game)};var setupGame=api.setupGame=function(game,newGame,portal){newGame=newGame===undefined?true:newGame;portal=portal||null;var playerPlaced=true,startMapIndex=0,wMap=game.worldMap;game.mapIndex=0;game.player.HP=game.player.maxHP;game.mode="map";var result=applyMapStringsToMaps(game,newGame,portal,{});playerPlaced=result.playerPlaced;startMapIndex=result.startMapIndex;setupGroups(game);setupPortals(game);if(portal){startMapIndex=portal.dmi;game.mapIndex=startMapIndex;game.player.currentCellIndex=null;placeUnit(game,game.player,portal.dx,portal.dy,portal.dmi);playerPlaced=true}if(!playerPlaced){placePlayer(game)}game.mapIndex=startMapIndex;game.toMap=getToMap(game);game.remainingEnemies=getRemainingEnemies(game)};api.create=function(opt){opt=opt||{};opt.w=opt.w||9;opt.h=opt.h||7;opt.marginX=opt.marginX===undefined?0:opt.marginX;opt.marginY=opt.marginY===undefined?0:opt.marginY;var wMap=opt.worldMap=opt.worldMap||api.VOID_WORLD;var game={sm:opt.sm||{},mode:"map",turn:0,turnState:"wait",worldMap:wMap,marginX:opt.marginY,marginX:opt.marginY,maps:[],mapIndex:0,toMap:{index:null,x:null,y:null},player:unitMod.createUnit("player"),remainingEnemies:0,options:new poolMod.create(menuPool),pointerDownTime:new Date};createCleanMaps(game);setupGame(game,true);return game};var processMeele=function(game,unit){var targetCellIndex=unit.meleeTarget,map=game.maps[game.mapIndex];if(targetCellIndex!=null){var targetCell=mapMod.get(map,targetCellIndex),tUnit=targetCell.unit;if(tUnit){unitMod.meleeAttack(unit,tUnit);if(tUnit.HP<=0&&tUnit.type==="enemy"){unitMod.giveXP(game.player,tUnit.xpValue);targetCell.walkable=true;if(tUnit.children.type==="group"){targetCell.unit=tUnit.children}else{targetCell.unit=null}}}unit.meleeTarget=null}};var processTurn=function(game,secs){var map=game.maps[game.mapIndex],pCell=api.getPlayerCell(game),eCells=getCellsByUnitType(map,"enemy");if(game.turnState==="wait"){return}if(game.turnState==="start"){eCells.forEach(function(eCell){var d=utils.distance(eCell.x+16,eCell.y+16,pCell.x+16,pCell.y+16);if(d<=1.5){eCell.unit.meleeTarget=pCell.i}else{eCell.unit.moveCells=getEnemeyMoveCells(game,eCell)}});game.turnState="move"}if(game.turnState==="move"){moveUnit(game,game.player);eCells=getCellsByUnitType(map,"enemy");eCells.forEach(function(eCell){moveUnit(game,eCell.unit)});var eCells=getCellsByUnitType(map,"enemy");if(game.player.moveCells.length===0&&eCells.every(function(eCell){return eCell.unit.moveCells.length===0})){game.turnState="melee"}}if(game.turnState==="melee"){processMeele(game,game.player);var eCells=getCellsByUnitType(map,"enemy");eCells.forEach(function(eCell){processMeele(game,eCell.unit)});game.turnState="end"}if(game.turnState==="end"){game.turn+=1;game.turnState="wait";if(game.player.HP<=0){pCell.unit=null;pCell.walkable=true;callMapEvent(game,secs,"onPlayerDeath",MAP_EVENTS.softMapReset)}game.remainingEnemies=getRemainingEnemies(game);if(game.remainingEnemies===0){callMapEvent(game,secs,"onNoEnemies",MAP_EVENTS.hardMapReset)}}};api.update=function(sm,secs){var game=sm.game;if(game.mode==="map"){processTurn(game,secs)}if(game.mode==="menu"){poolMod.update(game.options,secs,sm)}};api.getPlayerCell=function(game){var p=game.player,map=game.maps[game.mapIndex];return map.cells[p.currentCellIndex]};api.pointerStart=function(sm,x,y){var game=sm.game;game.pointerDownTime=new Date};api.pointerEnd=function(sm,x,y){var game=sm.game,now=new Date,clickedCell=mapMod.getCellByPointer(game.maps[game.mapIndex],x,y),map=game.maps[game.mapIndex],pCell=api.getPlayerCell(game);secs=(now-game.pointerDownTime)/1e3;if(secs>=.5){if(game.mode==="map"){game.mode="menu";game.options.data.mode="enter";createMenu(game)}}if(secs<.5){if(game.mode==="map"&&clickedCell){utils.log(clickedCell,"debug");if(clickedCell===pCell&&game.toMap.index!=null){if(game.toMap.options.length>1){startMenu(game,"main")}else{changeMap(game)}return}if(clickedCell.unit){var unit=clickedCell.unit;if(unit.type==="enemy"){game.player.meleeTarget=clickedCell.i;game.turnState="start";return}if(unit.type==="player"){return}}game.player.moveCells=getMoveCells(game,pCell,clickedCell);game.turnState="start"}if(game.mode==="menu"){var clicked=poolMod.getOverlaping({active:true,w:1,h:1,x:x,y:y},game.options);if(clicked.length>=1){game.options.data.activeButton=clicked[0]}else{game.options.data.mode="exit";game.options.data.activeButton=null}}}};return api}();var draw=function(){var api={};var unitColors=["green","gray","blue","red","purple","black","white"];var drawHPBar=function(sm,cell){var unit=cell.unit;var ctx=sm.ctx;var map=sm.game.maps[sm.game.mapIndex];var cs=map.cellSize;var x=map.margin.x+cell.x*cs;var y=map.margin.y+cell.y*cs;if(unit){if(unit.type=="player"||unit.type==="enemy"){ctx.fillStyle="gray";ctx.beginPath();ctx.rect(x,y,cs,5);ctx.fill();ctx.stroke();var per=unit.HP/unit.maxHP;ctx.fillStyle="lime";ctx.beginPath();ctx.rect(x,y,cs*per,5);ctx.fill();ctx.stroke()}}};var drawCell=function(sm,cell){var map=sm.game.maps[sm.game.mapIndex];var ctx=sm.ctx;var cs=map.cellSize;var x=map.margin.x+cell.x*cs;var y=map.margin.y+cell.y*cs;ctx.fillStyle=unitColors[0];if(cell.unit){if(cell.unit.type!="group"){ctx.fillStyle=unitColors[cell.unit.sheetIndex]}}ctx.beginPath();ctx.rect(x,y,cs,cs);ctx.fill();if(cell.unit){ctx.beginPath();ctx.rect(x+2,y+2,cs-4,cs-4);ctx.strokeStyle="#222222";if(cell.unit.type==="group"){ctx.strokeStyle=unitColors[cell.unit.sheetIndex]}ctx.stroke();drawHPBar(sm,cell)}};api.back=function(sm,style){var canvas=sm.canvas,ctx=sm.ctx;ctx.fillStyle=style||"black";ctx.fillRect(0,0,canvas.width,canvas.height)};var forMenuKey={item:function(sm,ctx,canvas){ctx.fillStyle="yellow";ctx.textAlign="center";ctx.textBaseline="top";ctx.font="9px courier";var x=canvas.width/2,y=canvas.height/2-40;var cw=sm.game.player.currentWeapon;ctx.fillText("Current Weapon: ",x,y);if(cw){ctx.fillText("baseAttack "+cw.baseAttack,x,y+10)}else{ctx.fillText("Unarmed ",x,y+10)}var mw=sm.game.options.data.menuOpt.item;ctx.fillText("This Weapon: ",x,y+30);ctx.fillText("baseAttack "+mw.baseAttack,x,y+40)}};api.options=function(sm){var canvas=sm.canvas,pool=sm.game.options,ctx=sm.ctx,opt={};ctx.fillStyle="yellow";ctx.textAlign="left";ctx.textBaseline="middle";ctx.font="12px courier";var d=pool.data;ctx.fillText("menuKey: "+d.menuKey,10,10);d.lines.forEach(function(line,i){ctx.fillText(line,10,10+15*(i+1))});var fm=forMenuKey[d.menuKey];if(fm){fm(sm,ctx,canvas)}pool.objects.forEach(function(obj){ctx.fillStyle=opt.fillStyle||obj.data.fillStyle||"white";ctx.strokeStyle=opt.strokeStyle||obj.data.strokeStyle||"black";if(obj.active||opt.drawAll){var cx=obj.x+obj.w/2,cy=obj.y+obj.h/2;ctx.beginPath();ctx.arc(cx,cy,(obj.w+obj.h)/2/2,0,Math.PI*2);ctx.fill();ctx.stroke();if(obj.data.desc){ctx.fillStyle="black";ctx.textAlign="center";ctx.textBaseline="middle";ctx.font="10px courier";if(obj.data.subText){ctx.fillText(obj.data.desc,cx,cy-7);ctx.font="9px courier";ctx.fillText(obj.data.subText,cx,cy+7)}else{ctx.fillText(obj.data.desc,cx,cy)}}}})};api.titleText=function(sm){var canvas=sm.canvas,ctx=sm.ctx;ctx.fillStyle="white";ctx.font="20px courier";ctx.textBaseline="top";ctx.textAlign="center";var x=canvas.width/2,y=canvas.height*.25;ctx.fillText("Turn Based RPG Prototype",x,y)};api.map=function(sm){var map=sm.game.maps[sm.game.mapIndex],i=0,len=map.cells.length;while(i<len){drawCell(sm,map.cells[i]);i+=1}};api.ver=function(sm,style){var ctx=sm.ctx,canvas=sm.canvas;ctx.fillStyle=style||"white";ctx.font="10px courier";ctx.textBaseline="top";ctx.textAlign="left";ctx.fillText("v"+sm.ver,1,canvas.height-10)};var getY=function(yi){return 5+12*yi};api.info=function(sm){var ctx=sm.ctx,pos=sm.input.pos,pCell=gameMod.getPlayerCell(sm.game),canvas=sm.canvas,dy=12;ctx.fillStyle="yellow";ctx.font="10px courier";ctx.textBaseline="top";ctx.textAlign="left";var p=sm.game.player,pl=p.levelObj;ctx.fillText("level: "+pl.level+", xp: "+pl.xp+", xp to next: "+pl.toNext,5,getY(0));ctx.fillText("HP: "+p.HP+" / "+p.maxHP,5,getY(1));ctx.fillText("attack: "+p.attack[0]+" - "+p.attack[1],5,getY(2));ctx.fillText("defense: "+p.baseDefense[0]+" - "+p.baseDefense[1],5,getY(3));var w=p.currentWeapon;if(w){ctx.fillText("wepaon attack: "+w.baseAttack[0]+" - "+w.baseAttack[1],5,getY(4))}else{ctx.fillText("wepaon: unarmed",5,getY(4))}};return api}();var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),container=document.getElementById("canvas-app")||document.body;container.appendChild(canvas);canvas.width=320;canvas.height=240;canvas.className="canvas-layer";ctx.translate(.5,.5);canvas.onselectstart=function(){return false};var sm={ver:"0.16.0",fps:12,lt:new Date,states:{},stateObj:null,currentState:"",data:{},loader:{json:{baseURL:"./json",fileNames:["world-home","world-forest","items-home"]}},game:{},canvas:canvas,ctx:ctx,input:{pointerDown:false,pos:{x:0,y:0}}};sm.setState=function(newStateKey){var oldState=sm.states[sm.currentState];if(oldState){if(oldState.end){oldState.end.call(sm,sm)}}sm.currentState=newStateKey;sm.stateObj=sm.states[sm.currentState];if(sm.stateObj){if(sm.stateObj.start){sm.stateObj.start.call(sm,sm)}}};sm.callStateEvent=function(eventKey,e,opt){if(sm.stateObj){var events=sm.stateObj.events;if(events){if(events[eventKey]){events[eventKey].call(sm,e,opt,sm)}}}};var pointerHanders={start:function(sm,e){var pos=sm.input.pos=utils.getCanvasRelative(e);if(e.type==="touchstart"){e.preventDefault()}sm.input.pointerDown=true;sm.callStateEvent("pointerStart",e,pos)},move:function(sm,e){var pos=sm.input.pos=utils.getCanvasRelative(e);sm.callStateEvent("pointerMove",e,pos)},end:function(sm,e){sm.input.pointerDown=false;sm.callStateEvent("pointerEnd",e,sm.input.pos)}};var createPointerHandler=function(sm,type){return function(e){pointerHanders[type](sm,e)}};canvas.addEventListener("touchstart",createPointerHandler(sm,"start"));canvas.addEventListener("touchmove",createPointerHandler(sm,"move"));canvas.addEventListener("touchend",createPointerHandler(sm,"end"));canvas.addEventListener("mousedown",createPointerHandler(sm,"start"));canvas.addEventListener("mousemove",createPointerHandler(sm,"move"));canvas.addEventListener("mouseup",createPointerHandler(sm,"end"));sm.startLoop=function(){var loop=function(){var now=new Date,secs=(now-sm.lt)/1e3;requestAnimationFrame(loop);if(secs>=1/sm.fps){sm.stateObj.update.call(sm,sm,secs);sm.stateObj.draw.call(sm,sm,{});sm.lt=now}};loop()};sm.states.loader={key:"loader",start:function(sm){if(sm.loader.json){var jl=sm.loader.json;i=0,count=jl.count=jl.fileNames.length;jl.loaded=0;jl.errorCount=0;jl.errors=[];if(location.protocol==="file:"){jl.errorCount=1;jl.errors.push("Game is running under file protocol.");return}while(i<count){(function(imageIndex){var fileName=jl.fileNames[i];utils.http({url:jl.baseURL+"/"+fileName+".json",onDone:function(json,xhr){try{var dataObj=JSON.parse(json);var dataKey=dataObj.dataKey||Object.keys(sm.data).length;sm.data[dataKey]=dataObj;jl.loaded+=1;if(jl.loaded===count){sm.setState("title")}}catch(e){jl.errorCount+=1;jl.errors.push("failed to parse JSON for file "+fileName+".json")}},onError:function(xhr){jl.errorCount+=1;jl.errors.push("did not get a 200 status for file "+fileName+".json")}})})(i);i+=1}}else{jl.errorCount=1;jl.errors.push("no json object in sm.loader.")}},end:function(sm){var jl=sm.loader.json;utils.log("**********","debug");utils.log("loader state over: ","debug");utils.log("loaded: "+jl.loaded+" / "+jl.count,"debug");utils.log("errors: "+jl.errorCount,"debug");utils.log(jl.errors,"debug");utils.log(sm.data,"debug");utils.log("**********","debug")},update:function(sm,secs){if(sm.loader.json.errorCount>0){sm.setState("title")}},draw:function(sm,layers){draw.back(sm);draw.ver(sm)}};sm.states.title={key:"title",start:function(sm){utils.log("title start","debug");unitMod.loadItems(sm.data)},update:function(sm,secs){},draw:function(sm,layers){draw.back(sm);draw.titleText(sm);draw.ver(sm)},events:{pointerEnd:function(e,pos,sm){sm.setState("game")}}};sm.states.game={key:"game",start:function(sm){var worldMap=gameMod.VOID_WORLD;if(sm.loader.json.errorCount===0){worldMap=sm.data.wm_home||gameMod.VOID_WORLD}sm.game=gameMod.create({sm:sm,worldMap:worldMap,marginX:14,marginY:7,w:9,h:7,mapStrings:worldMap.mapStrings})},update:function(sm,secs){gameMod.update(sm,secs)},draw:function(sm,layers){draw.back(sm);draw.map(sm);if(sm.game.mode==="map"){draw.info(sm)}if(sm.game.mode==="menu"){draw.back(sm,"rgba(0,0,0,0.5)");draw.options(sm)}draw.ver(sm)},events:{pointerStart:function(e,pos,sm){gameMod.pointerStart(sm,pos.x,pos.y)},pointerEnd:function(e,pos,sm){gameMod.pointerEnd(sm,pos.x,pos.y)}}};sm.loader.json.baseURL="../json";sm.setState("loader");sm.startLoop();
</script>
<!--
<script>
sm.loader.json.baseURL = '../json';
// set the current state
sm.setState('loader');
sm.startLoop();
</script>
-->
</body></html>
