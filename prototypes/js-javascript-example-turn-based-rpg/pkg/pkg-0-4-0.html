<html><head><title>javascript-example-grid-game-unit-movement</title></head><body> 

<div id="canvas-app"style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>var utils={};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.angleToPoint=function(x1,y1,x2,y2,scale){scale=scale===undefined?Math.PI*2:scale;var aTan=Math.atan2(y1-y2,x1-x2);return(aTan+Math.PI)/(Math.PI*2)*scale};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect();return{x:(e.touches?e.touches[0].clientX:e.clientX)-bx.left,y:(e.touches?e.touches[0].clientY:e.clientY)-bx.top,bx:bx}};utils.deepCloneJSON=function(obj){return JSON.parse(JSON.stringify(obj))};var mapMod=function(){var createCells=function(map){var cells=[];var len=map.w*map.h,i=0;while(i<len){cells.push({i:i,x:i%map.w,y:Math.floor(i/map.w),walkable:true,closed:false,data:{},unit:null});i+=1}return cells};var api={};api.create=function(opt){opt=opt||{};var map={w:opt.w||9,h:opt.h||7,cellSize:32,margin:{x:opt.marginX==undefined?5:opt.marginX,y:opt.marginY==undefined?5:opt.marginY},cells:[]};map.cells=opt.cells||createCells(map);return map};api.get=function(map,x,y){if(x<0||y<0||x>=map.w||y>=map.h){return false}return map.cells[y*map.w+x]};api.getCellByPointer=function(map,x,y){var cx=Math.floor((x-map.margin.x)/map.cellSize),cy=Math.floor((y-map.margin.y)/map.cellSize);return api.get(map,cx,cy)};var sortOpen=function(opened){return opened.sort(function(nodeA,nodeB){if(nodeA.weight<nodeB.weight){return 1}if(nodeA.weight>nodeB.weight){return-1}return 0})};var setWeight=function(endNode,neighbor){return utils.distance(endNode.x,endNode.y,neighbor.x,neighbor.y)};var buildPath=function(node){var path=[];while(node.parent){path.push([node.x,node.y]);node=node.parent}return path};var forNeighbors=function(grid,node,endNode,opened){var neighbors=mapMod.getNeighbors(grid,node);var ni=0,nl=neighbors.length;while(ni<nl){var neighbor=neighbors[ni];if(neighbor.closed){ni+=1;continue}neighbor.weight=setWeight(endNode,neighbor);if(!neighbor.opened){neighbor.parent=node;opened.push(neighbor);neighbor.opened=true}ni+=1}};api.getPath=function(grid,sx,sy,ex,ey){var grid=utils.deepCloneJSON(grid),nodes=api.chunk(grid),path=[],opened=[],node;var startNode=nodes[sy][sx];endNode=nodes[ey][ex];opened.push(startNode);startNode.opened=true;startNode.weight=0;while(opened.length>0){node=opened.pop();node.closed=true;if(node===endNode){return buildPath(node)}forNeighbors(grid,node,endNode,opened);sortOpen(opened)}return[]};api.chunk=function(grid){var arr=[],row,i=0;while(i<grid.cells.length){row=grid.cells.slice(i,i+grid.w);arr.push(row);i+=grid.w}return arr};api.isInBounds=function(grid,x,y){return x>=0&&x<grid.w&&(y>=0&&y<grid.h)};api.isWalkable=function(grid,x,y){if(api.isInBounds(grid,x,y)){return api.get(grid,x,y).walkable}return false};api.getNeighbors=function(grid,node){var x=node.x,y=node.y,neighbors=[];if(api.isWalkable(grid,x,y-1)){neighbors.push(mapMod.get(grid,x,y-1))}if(api.isWalkable(grid,x,y+1)){neighbors.push(mapMod.get(grid,x,y+1))}if(api.isWalkable(grid,x-1,y)){neighbors.push(mapMod.get(grid,x-1,y))}if(api.isWalkable(grid,x+1,y)){neighbors.push(mapMod.get(grid,x+1,y))}return neighbors};return api}();var gameMod=function(){var createBaseUnit=function(){return{HP:100,maxHP:100,weaponIndex:0,sheetIndex:0,currentCellIndex:null,active:false}};var createPlayerUnit=function(){var player=createBaseUnit();player.active=true;player.sheetIndex=2;return player};var createWallUnit=function(){var wall=createBaseUnit();wall.active=true;wall.sheetIndex=1;return wall};var placeUnit=function(game,unit,x,y){var map=game.maps[game.mapIndex];var newCell=mapMod.get(map,x,y);if(newCell){if(unit.currentCellIndex!=null){var oldCell=map.cells[unit.currentCellIndex];oldCell.walkable=true;map.cells[unit.currentCellIndex].unit=null}newCell.walkable=false;unit.currentCellIndex=newCell.i;map.cells[unit.currentCellIndex].unit=unit}};var placePlayer=function(game){var map=game.maps[game.mapIndex],toMap=game.toMap,toCell=null,i=map.cells.length;if(toMap.x!=null&&toMap.y!=null){toCell=mapMod.get(map,toMap.x,toMap.y)}if(toCell){if(!toCell.unit){placeUnit(game,game.player,toCell.x,toCell.y);return}}while(i--){var cell=map.cells[i];if(cell.unit===null){placeUnit(game,game.player,cell.x,cell.y);return}}};var setupGame=function(game,mapStrings){var playerPlaced=false,startMapIndex=0;game.mapIndex=0;game.maps=game.maps.map(function(map,mi){var mapStr=mapStrings[mi]||"";game.mapIndex=mi;map.cells=map.cells.map(function(cell,ci){var cellIndex=parseInt(mapStr[ci]||"0"),x=ci%map.w,y=Math.floor(ci/map.w);if(cellIndex===1){var wall=createWallUnit();placeUnit(game,wall,x,y)}if(cellIndex===2){playerPlaced=true;startMapIndex=mi;placeUnit(game,game.player,x,y)}return cell});return map});if(!playerPlaced){placePlayer(game)}game.mapIndex=startMapIndex};var api={};api.create=function(opt){opt=opt||{};var mapStrings=opt.maps||["2"];var game={mode:"map",maps:[],mapIndex:0,mapWorldWidth:3,toMap:{index:null,x:null,y:null},targetCell:false,player:createPlayerUnit()};mapStrings.forEach(function(){game.maps.push(mapMod.create({marginX:opt.marginX===undefined?32:opt.marginX,marginY:opt.marginY===undefined?32:opt.marginY,w:opt.w===undefined?4:opt.w,h:opt.h===undefined?4:opt.h}))});setupGame(game,mapStrings);return game};var getToIndex=function(game){var toIndex=null,p=game.player,map=game.maps[game.mapIndex],pCell=api.getPlayerCell(game),mwx=game.mapIndex%game.mapWorldWidth,mwy=Math.floor(game.mapIndex/game.mapWorldWidth);if(pCell.x===0){var x=mwx-1;x=x<0?game.mapWorldWidth-1:x;toIndex=mwy*game.mapWorldWidth+x}if(pCell.x===map.w-1){var x=mwx+1;x=x>=game.mapWorldWidth?0:x;toIndex=mwy*game.mapWorldWidth+x}if(pCell.y===0){var y=mwy-1;y=y<0?game.maps.length/game.mapWorldWidth-1:y;toIndex=y*game.mapWorldWidth+mwx}if(pCell.y===map.h-1){var y=mwy+1;y=y>=game.maps.length/game.mapWorldWidth?0:y;toIndex=y*game.mapWorldWidth+mwx}return toIndex};var getToMap=function(game){var toMap={};var map=game.maps[game.mapIndex];var pCell=api.getPlayerCell(game);var mi=toMap.index=getToIndex(game);toMap.x=pCell.x===0?map.w-1:pCell.x;toMap.y=pCell.y===0?map.h-1:pCell.y;toMap.x=pCell.x===map.w-1?0:toMap.x;toMap.y=pCell.y===map.h-1?0:toMap.y;return toMap};api.update=function(game,secs){var cell,radian,target;if(target=game.targetCell){cell=game.maps[game.mapIndex].cells[game.player.currentCellIndex];if(target!=cell){radian=utils.angleToPoint(cell.x,cell.y,target.x,target.y);var cx=Math.round(cell.x+Math.cos(radian)),cy=Math.round(cell.y+Math.sin(radian));placeUnit(game,game.player,cx,cy);game.toMap=getToMap(game);game.targetCell=false}}};api.getPlayerCell=function(game){var p=game.player,map=game.maps[game.mapIndex];return map.cells[p.currentCellIndex]};api.playerPointer=function(game,x,y){var cell=mapMod.getCellByPointer(game.maps[game.mapIndex],x,y),map=game.maps[game.mapIndex];if(cell){var pCell=api.getPlayerCell(game),path=mapMod.getPath(map,pCell.x,pCell.y,cell.x,cell.y),pos=path.pop();if(cell===pCell&&game.toMap.index!=null){console.log("map index change");game.mapIndex=game.toMap.index;game.toMap=getToMap(game);pCell.unit=null;pCell.walkable=true;game.player.currentCellIndex=null;placePlayer(game)}else{if(pos){var tCell=mapMod.get(map,pos[0],pos[1]);game.targetCell=tCell}}}};return api}();var draw=function(){var api={};var unitColors=["green","gray","blue","red"];var drawCell=function(sm,cell){var map=sm.game.maps[sm.game.mapIndex];var ctx=sm.ctx;var cs=map.cellSize;var x=map.margin.x+cell.x*cs;var y=map.margin.y+cell.y*cs;ctx.fillStyle="green";if(!cell.walkable){ctx.fillStyle="gray"}if(cell.unit){ctx.fillStyle=unitColors[cell.unit.sheetIndex]}ctx.beginPath();ctx.rect(x,y,32,32);ctx.fill();ctx.stroke()};api.back=function(sm){var canvas=sm.canvas,ctx=sm.ctx;ctx.fillStyle="black";ctx.fillRect(0,0,canvas.width,canvas.height)};api.map=function(sm){var map=sm.game.maps[sm.game.mapIndex],i=0,len=map.cells.length;while(i<len){drawCell(sm,map.cells[i]);i+=1}};api.info=function(sm){var ctx=sm.ctx,pos=sm.input.pos,pCell=gameMod.getPlayerCell(sm.game),canvas=sm.canvas;ctx.fillStyle="white";ctx.font="10px courier";ctx.textBaseline="top";ctx.fillText("pos: "+pos.x+","+pos.y,5,5);ctx.fillText("player pos: "+pCell.x+","+pCell.y,5,15);var tm=sm.game.toMap;ctx.fillText("toMap: mi:"+tm.index+", x: "+tm.x+", y: "+tm.y,5,25);ctx.fillText("v"+sm.ver,1,canvas.height-11)};return api}();(function(){var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),container=document.getElementById("canvas-app")||document.body;container.appendChild(canvas);canvas.width=320;canvas.height=240;ctx.translate(.5,.5);canvas.onselectstart=function(){return false};var sm={ver:"0.4.0",fps:12,lt:new Date,game:gameMod.create({marginX:14,marginY:7,w:9,h:7,maps:["111111111100000000100000000100000000100000000100000000100000000","111111111000000000000000000000000000000000000000000000000000000","111111111000000001000000001000000001000000001000000001000000001","100000001100000001100000000100000001100000001100000001100000001","100100000100111100020001000100101000100100100100100000100100000","000000001000000001000000001000000001000000001000000001000000001","100000001100000001100000001100000000100000000100000000111111111","100100000100000000100000000000000000000000000000000000111111111","000000001000000001000000001000000001000000001000000001111111111"]}),canvas:canvas,ctx:ctx,input:{pointerDown:false,pos:{x:0,y:0}}};var pointerHanders={start:function(sm,e){var pos=sm.input.pos=utils.getCanvasRelative(e);if(e.type==="touchstart"){e.preventDefault()}sm.input.pointerDown=true;gameMod.playerPointer(sm.game,pos.x,pos.y)},move:function(sm,e){sm.input.pos=utils.getCanvasRelative(e)},end:function(sm,e){sm.input.pointerDown=false}};var createPointerHandler=function(sm,type){return function(e){pointerHanders[type](sm,e)}};canvas.addEventListener("touchstart",createPointerHandler(sm,"start"));canvas.addEventListener("touchmove",createPointerHandler(sm,"move"));canvas.addEventListener("touchend",createPointerHandler(sm,"end"));canvas.addEventListener("mousedown",createPointerHandler(sm,"start"));canvas.addEventListener("mousemove",createPointerHandler(sm,"move"));canvas.addEventListener("mouseup",createPointerHandler(sm,"end"));var loop=function(){var now=new Date,secs=(now-sm.lt)/1e3;requestAnimationFrame(loop);if(secs>=1/sm.fps){gameMod.update(sm.game);draw.back(sm);draw.map(sm);draw.info(sm);sm.lt=now}};loop()})();
</script>

</body></html>
