<html><head><title>javascript-example-grid-game-unit-movement</title></head><body> 

<div id="canvas-app"style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>var utils={};utils.valueByRange=function(per,nMin,nMax){per=per===undefined?0:per;nMin=nMin===undefined?0:nMin;nMax=nMax===undefined?1:nMax;return nMin+Math.round(per*(nMax-nMin))};utils.boundingBox=function(x1,y1,w1,h1,x2,y2,w2,h2){return!(y1+h1<y2||y1>y2+h2||x1+w1<x2||x1>x2+w2)};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.angleToPoint=function(x1,y1,x2,y2,scale){scale=scale===undefined?Math.PI*2:scale;var aTan=Math.atan2(y1-y2,x1-x2);return(aTan+Math.PI)/(Math.PI*2)*scale};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect(),pos={x:Math.floor((e.touches?e.touches[0].clientX:e.clientX)-bx.left),y:Math.floor((e.touches?e.touches[0].clientY:e.clientY)-bx.top),bx:bx};pos.x=Math.floor(pos.x/canvas.scrollWidth*canvas.width);pos.y=Math.floor(pos.y/canvas.scrollHeight*canvas.height);return pos};utils.deepCloneJSON=function(obj){try{return JSON.parse(JSON.stringify(obj))}catch(e){console.log(e.message);console.log(obj);return{}}};var unitMod=function(){var api={};var setStat={};setStat.attack=function(unit){unit.attack=unit.baseAttack.map(function(ba,i){var cw=unit.currentWeapon!=null?unit.currentWeapon.attack[i]:0;return ba+cw})};var createBaseUnit=function(){var unit={maxHP:1,maxCellsPerTurn:0,baseAttack:[1,1],baseDefense:[0,0],attack:[0,0],meleeWeapon:null,currentWeapon:null,HP:1,weaponIndex:0,sheetIndex:0,type:null,meleeTarget:null,moveCells:[],currentCellIndex:null,active:true};setStat.attack(unit);return unit};var UNIT_TYPES={};UNIT_TYPES.player={create:function(player){player.maxCellsPerTurn=3;player.sheetIndex=2;player.maxHP=50;player.baseAttack=[1,3];player.baseDefense=[1,2];player.currentWeapon={attack:[5,7]};setStat.attack(player)}};UNIT_TYPES.enemy={create:function(enemy){enemy.maxCellsPerTurn=2;enemy.sheetIndex=3;enemy.maxHP=8;enemy.baseAttack=[2,5];enemy.baseDefense=[1,2];setStat.attack(enemy)}};UNIT_TYPES.wall={create:function(wall){wall.sheetIndex=1}};api.createUnit=function(type){var unit=createBaseUnit();unit.type=type;UNIT_TYPES[type].create(unit);return unit};api.meleeAttack=function(attacker,target){setStat.attack(attacker);var fa=attacker.attack,ra=utils.valueByRange(Math.random(),fa[0],fa[1]);var bd=target.baseDefense,d=utils.valueByRange(Math.random(),bd[0],bd[1]);var a=ra-d;a=a<0?0:a;target.HP-=a;target.HP=target.HP<0?0:target.HP};return api}();var mapMod=function(){var createCells=function(map){var cells=[];var len=map.w*map.h,i=0;while(i<len){cells.push({i:i,x:i%map.w,y:Math.floor(i/map.w),walkable:true,closed:false,data:{},unit:null});i+=1}return cells};var api={};api.create=function(opt){opt=opt||{};var map={w:opt.w||9,h:opt.h||7,cellSize:32,margin:{x:opt.marginX==undefined?5:opt.marginX,y:opt.marginY==undefined?5:opt.marginY},cells:[]};map.cells=opt.cells||createCells(map);return map};api.get=function(map,xi,y){if(arguments.length===2){return map.cells[xi]}if(xi<0||y<0||xi>=map.w||y>=map.h){return false}return map.cells[y*map.w+xi]};api.getCellByPointer=function(map,x,y){var cx=Math.floor((x-map.margin.x)/map.cellSize),cy=Math.floor((y-map.margin.y)/map.cellSize);return api.get(map,cx,cy)};var sortOpen=function(opened){return opened.sort(function(nodeA,nodeB){if(nodeA.weight<nodeB.weight){return 1}if(nodeA.weight>nodeB.weight){return-1}return 0})};var setWeight=function(endNode,neighbor){return utils.distance(endNode.x,endNode.y,neighbor.x,neighbor.y)};var buildPath=function(node){var path=[];while(node.parent){path.push([node.x,node.y]);node=node.parent}return path};var forNeighbors=function(grid,node,endNode,opened){var neighbors=mapMod.getNeighbors(grid,node);var ni=0,nl=neighbors.length;while(ni<nl){var neighbor=neighbors[ni];if(neighbor.closed){ni+=1;continue}neighbor.weight=setWeight(endNode,neighbor);if(!neighbor.opened){neighbor.parent=node;opened.push(neighbor);neighbor.opened=true}ni+=1}};api.getPath=function(grid,sx,sy,ex,ey){var grid=utils.deepCloneJSON(grid),nodes=api.chunk(grid),path=[],opened=[],node;var startNode=nodes[sy][sx];endNode=nodes[ey][ex];opened.push(startNode);startNode.opened=true;startNode.weight=0;while(opened.length>0){node=opened.pop();node.closed=true;if(node===endNode){return buildPath(node)}forNeighbors(grid,node,endNode,opened);sortOpen(opened)}return[]};api.chunk=function(grid){var arr=[],row,i=0;while(i<grid.cells.length){row=grid.cells.slice(i,i+grid.w);arr.push(row);i+=grid.w}return arr};api.isInBounds=function(grid,x,y){return x>=0&&x<grid.w&&(y>=0&&y<grid.h)};api.isWalkable=function(grid,x,y){if(api.isInBounds(grid,x,y)){return api.get(grid,x,y).walkable}return false};api.getNeighbors=function(grid,node){var x=node.x,y=node.y,neighbors=[];if(api.isWalkable(grid,x,y-1)){neighbors.push(mapMod.get(grid,x,y-1))}if(api.isWalkable(grid,x,y+1)){neighbors.push(mapMod.get(grid,x,y+1))}if(api.isWalkable(grid,x-1,y)){neighbors.push(mapMod.get(grid,x-1,y))}if(api.isWalkable(grid,x+1,y)){neighbors.push(mapMod.get(grid,x+1,y))}return neighbors};return api}();var gameMod=function(){var getToIndex=function(game){var toIndex=null,p=game.player,map=game.maps[game.mapIndex],pCell=api.getPlayerCell(game),mwx=game.mapIndex%game.mapWorldWidth,mwy=Math.floor(game.mapIndex/game.mapWorldWidth);if(pCell.x===0){var x=mwx-1;x=x<0?game.mapWorldWidth-1:x;toIndex=mwy*game.mapWorldWidth+x}if(pCell.x===map.w-1){var x=mwx+1;x=x>=game.mapWorldWidth?0:x;toIndex=mwy*game.mapWorldWidth+x}if(pCell.y===0){var y=mwy-1;y=y<0?game.maps.length/game.mapWorldWidth-1:y;toIndex=y*game.mapWorldWidth+mwx}if(pCell.y===map.h-1){var y=mwy+1;y=y>=game.maps.length/game.mapWorldWidth?0:y;toIndex=y*game.mapWorldWidth+mwx}return toIndex};var isAtCorner=function(game,cell){var map=game.maps[game.mapIndex],w=map.w-1,h=map.h-1;return cell.x===0&&cell.y===0||cell.x===w&&cell.y===h||cell.x===0&&cell.y===h||cell.x===w&&cell.y===0};var getToMap=function(game){var toMap={};var map=game.maps[game.mapIndex];var pCell=api.getPlayerCell(game);var mi=toMap.index=getToIndex(game);if(isAtCorner(game,pCell)){if(pCell.y===map.h-1){toMap.x=pCell.x;toMap.y=0}else{toMap.x=pCell.x;toMap.y=map.h-1}}else{toMap.x=pCell.x===0?map.w-1:pCell.x;toMap.y=pCell.y===0?map.h-1:pCell.y;toMap.x=pCell.x===map.w-1?0:toMap.x;toMap.y=pCell.y===map.h-1?0:toMap.y}return toMap};var getMovePath=function(game,startCell,targetCell){var map=game.maps[game.mapIndex],unit=startCell.unit||null;var path=mapMod.getPath(map,startCell.x,startCell.y,targetCell.x,targetCell.y);if(unit){path=path.reverse().slice(0,unit.maxCellsPerTurn)}return path};var getMoveCells=function(game,startCell,targetCell){var map=game.maps[game.mapIndex];return getMovePath(game,startCell,targetCell).map(function(pos){var cell=mapMod.get(map,pos[0],pos[1]);return cell.i})};var getEnemeyMoveCells=function(game,eCell){var pCell=api.getPlayerCell(game),map=game.maps[game.mapIndex];var pCellNeighbors=mapMod.getNeighbors(map,pCell).filter(function(cell){return cell.walkable});var mtcOptions=pCellNeighbors.map(function(cell){return getMoveCells(game,eCell,cell)}).filter(function(mtcOptions){return mtcOptions.length>0});return mtcOptions[0]||[]};var placeUnit=function(game,unit,x,y){var map=game.maps[game.mapIndex];var newCell=mapMod.get(map,x,y);if(newCell){if(unit.currentCellIndex!=null){var oldCell=map.cells[unit.currentCellIndex];oldCell.walkable=true;map.cells[unit.currentCellIndex].unit=null}newCell.walkable=false;unit.currentCellIndex=newCell.i;map.cells[unit.currentCellIndex].unit=unit}};var placePlayer=function(game){var map=game.maps[game.mapIndex],toMap=game.toMap,toCell=null,i=map.cells.length;if(toMap.x!=null&&toMap.y!=null){toCell=mapMod.get(map,toMap.x,toMap.y)}if(toCell){if(!toCell.unit){placeUnit(game,game.player,toCell.x,toCell.y);game.toMap=getToMap(game);return}}while(i--){var cell=map.cells[i];if(cell.unit===null){placeUnit(game,game.player,cell.x,cell.y);game.toMap=getToMap(game);return}}};var moveUnit=function(game,unit){if(unit.moveCells.length>0){var ci=unit.moveCells.shift();var moveToCell=mapMod.get(game.maps[game.mapIndex],ci);if(!moveToCell.unit){placeUnit(game,unit,moveToCell.x,moveToCell.y)}if(unit.type==="player"){game.toMap=getToMap(game)}}};var getCellsByUnitType=function(map,type){return map.cells.reduce(function(acc,cell){if(cell.unit){if(cell.unit.type===type){acc.push(cell)}}return acc},[])};var setupGame=function(game,newGame){newGame=newGame===undefined?true:newGame;var playerPlaced=false,startMapIndex=0;game.mapIndex=0;game.player.HP=game.player.maxHP;if(newGame){game.remainingEnemies=0}game.maps=game.maps.map(function(map,mi){var mapStr=game.mapStrings[mi]||"";game.mapIndex=mi;map.cells=map.cells.map(function(cell,ci){var cellIndex=parseInt(mapStr[ci]||"0"),x=ci%map.w,y=Math.floor(ci/map.w);if(cellIndex===0&&newGame){var cell=mapMod.get(map,ci);cell.unit=null;cell.walkable=true}if(cellIndex===1){var wall=unitMod.createUnit("wall");placeUnit(game,wall,x,y)}if(cellIndex===2){playerPlaced=true;startMapIndex=mi;placeUnit(game,game.player,x,y)}if(cellIndex===3&&newGame){game.remainingEnemies+=1;var enemy=unitMod.createUnit("enemy");enemy.HP=enemy.maxHP;placeUnit(game,enemy,x,y)}return cell});return map});if(!playerPlaced){placePlayer(game)}game.mapIndex=startMapIndex;game.toMap=getToMap(game)};var api={};api.create=function(opt){opt=opt||{};var game={turn:0,turnState:"wait",maps:[],mapIndex:0,mapWorldWidth:3,toMap:{index:null,x:null,y:null},mapStrings:opt.maps||["2"],player:unitMod.createUnit("player"),remainingEnemies:0};game.mapStrings.forEach(function(){game.maps.push(mapMod.create({marginX:opt.marginX===undefined?32:opt.marginX,marginY:opt.marginY===undefined?32:opt.marginY,w:opt.w===undefined?4:opt.w,h:opt.h===undefined?4:opt.h}))});setupGame(game,true);return game};var processMeele=function(game,unit){var targetCellIndex=unit.meleeTarget,map=game.maps[game.mapIndex];if(targetCellIndex!=null){var targetCell=mapMod.get(map,targetCellIndex),tUnit=targetCell.unit;if(tUnit){unitMod.meleeAttack(unit,tUnit);if(tUnit.HP<=0&&tUnit.type==="enemy"){targetCell.walkable=true;targetCell.unit=null}}unit.meleeTarget=null}};var getRemainingEnemies=function(game){return game.maps.reduce(function(acc,map){var eCells=getCellsByUnitType(map,"enemy");return acc+eCells.length},0)};var processTurn=function(game,secs){var map=game.maps[game.mapIndex],pCell=api.getPlayerCell(game),eCells=getCellsByUnitType(map,"enemy");if(game.turnState==="wait"){return}if(game.turnState==="start"){eCells.forEach(function(eCell){var d=utils.distance(eCell.x+16,eCell.y+16,pCell.x+16,pCell.y+16);if(d<=1.5){eCell.unit.meleeTarget=pCell.i}else{eCell.unit.moveCells=getEnemeyMoveCells(game,eCell)}});game.turnState="move"}if(game.turnState==="move"){moveUnit(game,game.player);eCells.forEach(function(eCell){moveUnit(game,eCell.unit)});var eCells=getCellsByUnitType(map,"enemy");if(game.player.moveCells.length===0&&eCells.every(function(eCell){return eCell.unit.moveCells.length===0})){game.turnState="melee"}}if(game.turnState==="melee"){processMeele(game,game.player);var eCells=getCellsByUnitType(map,"enemy");eCells.forEach(function(eCell){processMeele(game,eCell.unit)});game.turnState="end"}if(game.turnState==="end"){game.turn+=1;game.turnState="wait";if(game.player.HP<=0){pCell.unit=null;pCell.walkable=true;setupGame(game,false)}game.remainingEnemies=getRemainingEnemies(game);if(game.remainingEnemies===0){setupGame(game,true)}}};api.update=function(game,secs){processTurn(game,secs)};api.getPlayerCell=function(game){var p=game.player,map=game.maps[game.mapIndex];return map.cells[p.currentCellIndex]};api.playerPointer=function(game,x,y){var clickedCell=mapMod.getCellByPointer(game.maps[game.mapIndex],x,y),map=game.maps[game.mapIndex],pCell=api.getPlayerCell(game);if(clickedCell){if(clickedCell===pCell&&game.toMap.index!=null){game.mapIndex=game.toMap.index;game.toMap=getToMap(game);pCell.unit=null;pCell.walkable=true;game.player.currentCellIndex=null;placePlayer(game);return}if(clickedCell.unit){var unit=clickedCell.unit;if(unit.type==="enemy"){game.player.meleeTarget=clickedCell.i;game.turnState="start";return}}game.player.moveCells=getMoveCells(game,pCell,clickedCell);game.turnState="start"}};return api}();var draw=function(){var api={};var unitColors=["green","gray","blue","red"];var drawHPBar=function(sm,cell){var unit=cell.unit;var ctx=sm.ctx;var map=sm.game.maps[sm.game.mapIndex];var cs=map.cellSize;var x=map.margin.x+cell.x*cs;var y=map.margin.y+cell.y*cs;if(unit){if(unit.type=="player"||unit.type==="enemy"){ctx.fillStyle="gray";ctx.beginPath();ctx.rect(x,y,cs,5);ctx.fill();ctx.stroke();var per=unit.HP/unit.maxHP;ctx.fillStyle="lime";ctx.beginPath();ctx.rect(x,y,cs*per,5);ctx.fill();ctx.stroke()}}};var drawCell=function(sm,cell){var map=sm.game.maps[sm.game.mapIndex];var ctx=sm.ctx;var cs=map.cellSize;var x=map.margin.x+cell.x*cs;var y=map.margin.y+cell.y*cs;ctx.fillStyle=unitColors[0];if(cell.unit){ctx.fillStyle=unitColors[cell.unit.sheetIndex]}ctx.beginPath();ctx.rect(x,y,cs,cs);ctx.fill();ctx.stroke();drawHPBar(sm,cell)};api.back=function(sm){var canvas=sm.canvas,ctx=sm.ctx;ctx.fillStyle="black";ctx.fillRect(0,0,canvas.width,canvas.height)};api.titleText=function(sm){var canvas=sm.canvas,ctx=sm.ctx;ctx.fillStyle="white";ctx.font="20px courier";ctx.textBaseline="top";ctx.textAlign="center";var x=canvas.width/2,y=canvas.height*.25;ctx.fillText("Turn Based RPG Prototype",x,y)};api.map=function(sm){var map=sm.game.maps[sm.game.mapIndex],i=0,len=map.cells.length;while(i<len){drawCell(sm,map.cells[i]);i+=1}};api.ver=function(sm,style){var ctx=sm.ctx,canvas=sm.canvas;ctx.fillStyle=style||"white";ctx.font="8px courier";ctx.textBaseline="top";ctx.textAlign="left";ctx.fillText("v"+sm.ver,1,canvas.height-10)};api.info=function(sm){var ctx=sm.ctx,pos=sm.input.pos,pCell=gameMod.getPlayerCell(sm.game),canvas=sm.canvas,dy=14;ctx.fillStyle="yellow";ctx.font="12px courier";ctx.textBaseline="top";ctx.textAlign="left";ctx.fillText("pos: "+pos.x+","+pos.y,5,5+dy*0);ctx.fillText("player pos: "+pCell.x+","+pCell.y,5,5+dy*1);var tm=sm.game.toMap;ctx.fillText("toMap: mi:"+tm.index+", x: "+tm.x+", y: "+tm.y,5,5+dy*2);ctx.fillText("turn:"+sm.game.turn+", turnState: "+sm.game.turnState,5,5+dy*3);ctx.fillText("enemies:"+sm.game.remainingEnemies,5,5+dy*4)};return api}();var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),container=document.getElementById("canvas-app")||document.body;container.appendChild(canvas);canvas.width=320;canvas.height=240;canvas.className="canvas-layer";ctx.translate(.5,.5);canvas.onselectstart=function(){return false};var sm={ver:"0.3.0",fps:12,lt:new Date,states:{},stateObj:null,currentState:"game",game:gameMod.create({marginX:14,marginY:7,w:9,h:7,maps:["111111111"+"100000000"+"103030000"+"100000000"+"100000000"+"100000000"+"100000001","111111111"+"000000000"+"000000300"+"000000000"+"000000000"+"000000000"+"100100000","111111111"+"000000001"+"000000301"+"000000001"+"000000301"+"000000001"+"000000301","100000001"+"103000001"+"100000000"+"100000001"+"100000001"+"103000001"+"100000001","100100000"+"100111010"+"020001010"+"100101030"+"100100111"+"100100000"+"100100000","000000001"+"000000001"+"000000031"+"000111111"+"111100031"+"000000001"+"000000001","100000001"+"100000001"+"100000001"+"103000000"+"100000000"+"103030000"+"111111111","100100000"+"100000000"+"100000000"+"000000000"+"000000000"+"000000300"+"111111111","000000001"+"000000001"+"000000001"+"000000301"+"000000001"+"000000301"+"111111111"]}),canvas:canvas,ctx:ctx,input:{pointerDown:false,pos:{x:0,y:0}}};sm.setState=function(newStateKey){sm.currentState=newStateKey;sm.stateObj=sm.states[sm.currentState]};sm.callStateEvent=function(eventKey,e,opt){if(sm.stateObj){var events=sm.stateObj.events;if(events){if(events[eventKey]){events[eventKey].call(sm,e,opt,sm)}}}};var pointerHanders={start:function(sm,e){var pos=sm.input.pos=utils.getCanvasRelative(e);if(e.type==="touchstart"){e.preventDefault()}sm.input.pointerDown=true;sm.callStateEvent("pointerStart",e,pos)},move:function(sm,e){var pos=sm.input.pos=utils.getCanvasRelative(e);sm.callStateEvent("pointerMove",e,pos)},end:function(sm,e){sm.input.pointerDown=false;sm.callStateEvent("pointerEnd",e,{})}};var createPointerHandler=function(sm,type){return function(e){pointerHanders[type](sm,e)}};canvas.addEventListener("touchstart",createPointerHandler(sm,"start"));canvas.addEventListener("touchmove",createPointerHandler(sm,"move"));canvas.addEventListener("touchend",createPointerHandler(sm,"end"));canvas.addEventListener("mousedown",createPointerHandler(sm,"start"));canvas.addEventListener("mousemove",createPointerHandler(sm,"move"));canvas.addEventListener("mouseup",createPointerHandler(sm,"end"));sm.states.title={key:"title",update:function(sm,secs){},draw:function(sm,layers){draw.back(sm);draw.titleText(sm);draw.ver(sm)},events:{pointerStart:function(e,pos,sm){sm.setState("game")}}};sm.states.game={key:"game",update:function(sm,secs){gameMod.update(sm.game)},draw:function(sm,layers){draw.back(sm);draw.map(sm);draw.info(sm);draw.ver(sm)},events:{pointerStart:function(e,pos,sm){gameMod.playerPointer(sm.game,pos.x,pos.y)}}};sm.setState("title");var loop=function(){var now=new Date,secs=(now-sm.lt)/1e3;requestAnimationFrame(loop);if(secs>=1/sm.fps){sm.stateObj.update.call(sm,sm,secs);sm.stateObj.draw.call(sm,sm,{});sm.lt=now}};loop();
</script>

</body></html>
