<html><head><title>javascript-example-grid-game-unit-movement</title></head><body> 

<div id="canvas-app"style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>var utils={};utils.valueByRange=function(per,nMin,nMax){per=per===undefined?0:per;nMin=nMin===undefined?0:nMin;nMax=nMax===undefined?1:nMax;return nMin+Math.round(per*(nMax-nMin))};utils.boundingBox=function(x1,y1,w1,h1,x2,y2,w2,h2){return!(y1+h1<y2||y1>y2+h2||x1+w1<x2||x1>x2+w2)};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.angleToPoint=function(x1,y1,x2,y2,scale){scale=scale===undefined?Math.PI*2:scale;var aTan=Math.atan2(y1-y2,x1-x2);return(aTan+Math.PI)/(Math.PI*2)*scale};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect(),pos={x:Math.floor((e.touches?e.touches[0].clientX:e.clientX)-bx.left),y:Math.floor((e.touches?e.touches[0].clientY:e.clientY)-bx.top),bx:bx};pos.x=Math.floor(pos.x/canvas.scrollWidth*canvas.width);pos.y=Math.floor(pos.y/canvas.scrollHeight*canvas.height);return pos};utils.deepCloneJSON=function(obj){try{return JSON.parse(JSON.stringify(obj))}catch(e){console.log(e.message);console.log(obj);return{}}};var poolMod=function(){var api={};var getInactive=function(pool){var i=pool.objects.length,obj;while(i--){obj=pool.objects[i];if(!obj.active){return obj}}return false};api.create=function(opt){opt=opt||{};opt.count=opt.count||10;var i=0,pool={objects:[],secsCap:opt.secsCap===undefined?Infinity:opt.secsCap,disableLifespan:opt.disableLifespan||false,data:opt.data||{},spawn:opt.spawn||function(obj,pool,state,opt){},purge:opt.purge||function(obj,pool,state){},update:opt.update||function(obj,pool,state,secs){}};while(i<opt.count){pool.objects.push({active:false,i:i,x:opt.x===undefined?0:opt.x,y:opt.y===undefined?0:opt.y,w:opt.w===undefined?32:opt.w,h:opt.h===undefined?32:opt.h,heading:opt.heading===undefined?0:opt.heading,pps:opt.pps===undefined?32:opt.pps,lifespan:opt.lifespan||3,data:{}});i+=1}return pool};api.spawn=function(pool,state,opt){var obj=getInactive(pool);state=state||{};opt=opt||{};if(obj){if(!obj.active){obj.active=true;pool.spawn.call(pool,obj,pool,state,opt);return obj}}return false};api.spawnAll=function(pool,state,opt){pool.objects.forEach(function(obj){if(!obj.active){obj.active=true;pool.spawn.call(pool,obj,pool,state,opt);return obj}});return pool.objects};api.purge=function(pool,obj,state){obj.active=false;pool.purge.call(pool,obj,pool,state)};api.purgeAll=function(pool,state,opt){pool.objects.forEach(function(obj){if(!obj.active){obj.active=false;pool.purge.call(pool,obj,pool,state)}});return pool.objects};api.update=function(pool,secs,state){var i=pool.objects.length,obj;state=state||{};secs=secs>pool.secsCap?pool.secsCap:secs;while(i--){obj=pool.objects[i];if(obj.active){pool.update.call(pool,obj,pool,state,secs);if(pool.disableLifespan){}else{obj.lifespan-=secs;obj.lifespan=obj.lifespan<0?0:obj.lifespan;if(obj.lifespan===0){obj.active=false;api.purge.call(pool,pool,obj,state)}}}}};api.setActiveStateForAll=function(pool,bool){bool=bool===undefined?false:bool;var i=pool.objects.length,obj;while(i--){obj=pool.objects[i];obj.active=bool}};api.moveByPPS=function(obj,secs){obj.x+=Math.cos(obj.heading)*obj.pps*secs;obj.y+=Math.sin(obj.heading)*obj.pps*secs};api.checkBounds=function(obj,canvas){if(obj.x>=canvas.width||obj.x<obj.w*-1||obj.y>canvas.height||obj.y<obj.h*-1){return false}return true};api.boundingBox=function(a,b){return utils.boundingBox(a.x,a.y,a.w,a.h,b.x,b.y,b.w,b.h)};api.wrap=function(obj,area,space){area=area||{x:0,y:0,width:640,height:480};space=space===undefined?32:space;if(!utils.boundingBox(obj.x,obj.y,obj.w,obj.h,space*-1,space*-1,area.width+space,area.height+space)){obj.x=utils.mod(obj.x+space,area.width+space*2)-space;obj.y=utils.mod(obj.y+space,area.height+space*2)-space}};api.getOverlaping=function(obj,pool){var i=0,obj2,overlap=[];len=pool.objects.length;if(obj.active){while(i<len){obj2=pool.objects[i];if(obj!=obj2&&obj2.active){if(utils.boundingBox(obj.x,obj.y,obj.w,obj.h,obj2.x,obj2.y,obj2.w,obj2.h)){overlap.push(obj2)}}i+=1}}return overlap};api.getActiveCount=function(pool){return pool.objects.reduce(function(acc,obj){return obj.active?acc+=1:acc},0)};api.getActiveObjects=function(pool){return pool.objects.reduce(function(acc,obj){if(obj.active){acc.push(obj)}return acc},[])};api.getDistanceToObj=function(obj1,obj2){var x1=obj2.x+obj2.w/2,y1=obj2.y+obj2.h/2,x2=obj1.x+obj1.w/2,y2=obj1.y+obj1.h/2;return utils.distance(x1,y1,x2,y2)};return api}();var unitMod=function(){var api={};var setStat={};setStat.attack=function(unit){unit.attack=unit.baseAttack.map(function(ba,i){var cw=unit.currentWeapon!=null?unit.currentWeapon.attack[i]:0;return ba+cw})};var createBaseUnit=function(){var unit={maxHP:1,maxCellsPerTurn:0,baseAttack:[1,1],baseDefense:[0,0],attack:[0,0],meleeWeapon:null,currentWeapon:null,HP:1,weaponIndex:0,sheetIndex:0,type:null,meleeTarget:null,moveCells:[],currentCellIndex:null,active:true};setStat.attack(unit);return unit};var UNIT_TYPES={};UNIT_TYPES.player={create:function(player){player.maxCellsPerTurn=3;player.sheetIndex=2;player.maxHP=50;player.baseAttack=[1,3];player.baseDefense=[1,2];player.currentWeapon={attack:[5,7]};setStat.attack(player)}};UNIT_TYPES.enemy={create:function(enemy){enemy.maxCellsPerTurn=2;enemy.sheetIndex=3;enemy.maxHP=8;enemy.baseAttack=[2,5];enemy.baseDefense=[1,2];setStat.attack(enemy)}};UNIT_TYPES.wall={create:function(wall){wall.sheetIndex=1}};api.createUnit=function(type){var unit=createBaseUnit();unit.type=type;UNIT_TYPES[type].create(unit);return unit};api.meleeAttack=function(attacker,target){setStat.attack(attacker);var fa=attacker.attack,ra=utils.valueByRange(Math.random(),fa[0],fa[1]);var bd=target.baseDefense,d=utils.valueByRange(Math.random(),bd[0],bd[1]);var a=ra-d;a=a<0?0:a;target.HP-=a;target.HP=target.HP<0?0:target.HP};return api}();var mapMod=function(){var createCells=function(map){var cells=[];var len=map.w*map.h,i=0;while(i<len){cells.push({i:i,x:i%map.w,y:Math.floor(i/map.w),walkable:true,closed:false,data:{},unit:null});i+=1}return cells};var api={};api.create=function(opt){opt=opt||{};var map={w:opt.w||9,h:opt.h||7,cellSize:32,margin:{x:opt.marginX==undefined?5:opt.marginX,y:opt.marginY==undefined?5:opt.marginY},cells:[]};map.cells=opt.cells||createCells(map);return map};api.get=function(map,xi,y){if(arguments.length===2){return map.cells[xi]}if(xi<0||y<0||xi>=map.w||y>=map.h){return false}return map.cells[y*map.w+xi]};api.getCellByPointer=function(map,x,y){var cx=Math.floor((x-map.margin.x)/map.cellSize),cy=Math.floor((y-map.margin.y)/map.cellSize);return api.get(map,cx,cy)};var sortOpen=function(opened){return opened.sort(function(nodeA,nodeB){if(nodeA.weight<nodeB.weight){return 1}if(nodeA.weight>nodeB.weight){return-1}return 0})};var setWeight=function(endNode,neighbor){return utils.distance(endNode.x,endNode.y,neighbor.x,neighbor.y)};var buildPath=function(node){var path=[];while(node.parent){path.push([node.x,node.y]);node=node.parent}return path};var forNeighbors=function(grid,node,endNode,opened){var neighbors=mapMod.getNeighbors(grid,node);var ni=0,nl=neighbors.length;while(ni<nl){var neighbor=neighbors[ni];if(neighbor.closed){ni+=1;continue}neighbor.weight=setWeight(endNode,neighbor);if(!neighbor.opened){neighbor.parent=node;opened.push(neighbor);neighbor.opened=true}ni+=1}};api.getPath=function(grid,sx,sy,ex,ey){var grid=utils.deepCloneJSON(grid),nodes=api.chunk(grid),path=[],opened=[],node;var startNode=nodes[sy][sx];endNode=nodes[ey][ex];opened.push(startNode);startNode.opened=true;startNode.weight=0;while(opened.length>0){node=opened.pop();node.closed=true;if(node===endNode){return buildPath(node)}forNeighbors(grid,node,endNode,opened);sortOpen(opened)}return[]};api.chunk=function(grid){var arr=[],row,i=0;while(i<grid.cells.length){row=grid.cells.slice(i,i+grid.w);arr.push(row);i+=grid.w}return arr};api.isInBounds=function(grid,x,y){return x>=0&&x<grid.w&&(y>=0&&y<grid.h)};api.isWalkable=function(grid,x,y){if(api.isInBounds(grid,x,y)){return api.get(grid,x,y).walkable}return false};api.getNeighbors=function(grid,node){var x=node.x,y=node.y,neighbors=[];if(api.isWalkable(grid,x,y-1)){neighbors.push(mapMod.get(grid,x,y-1))}if(api.isWalkable(grid,x,y+1)){neighbors.push(mapMod.get(grid,x,y+1))}if(api.isWalkable(grid,x-1,y)){neighbors.push(mapMod.get(grid,x-1,y))}if(api.isWalkable(grid,x+1,y)){neighbors.push(mapMod.get(grid,x+1,y))}return neighbors};return api}();var gameMod=function(){var api={};var isAtCorner=function(game,cell){var map=game.maps[game.mapIndex],w=map.w-1,h=map.h-1;return cell.x===0&&cell.y===0||cell.x===w&&cell.y===h||cell.x===0&&cell.y===h||cell.x===w&&cell.y===0};var getToIndexOptions=function(game,x,y,ox,oy){var toIndex=null,dir,p=game.player,map=game.maps[game.mapIndex],cell=mapMod.get(map,x,y),mwx=game.mapIndex%game.mapWorldWidth,mwy=Math.floor(game.mapIndex/game.mapWorldWidth),options=[];if(isAtCorner(game,cell)){if(x===0&&y===0){return getToIndexOptions(game,0,1,x,y).concat(getToIndexOptions(game,1,0,x,y))}if(x===map.w-1&&y===0){return getToIndexOptions(game,map.w-1,1,x,y).concat(getToIndexOptions(game,map.w-2,0,x,y))}if(x===map.w-1&&y===map.h-1){return getToIndexOptions(game,map.w-1,map.h-2,x,y).concat(getToIndexOptions(game,map.w-2,map.h-1,x,y))}if(x===0&&y===map.h-1){return getToIndexOptions(game,0,map.h-2,x,y).concat(getToIndexOptions(game,map.w-2,map.h-1,x,y))}}else{if(x===0){var x=mwx-1;x=x<0?game.mapWorldWidth-1:x;toIndex=mwy*game.mapWorldWidth+x;dir="west"}if(x===map.w-1){var x=mwx+1;x=x>=game.mapWorldWidth?0:x;toIndex=mwy*game.mapWorldWidth+x;dir="east"}if(y===0){var y=mwy-1;y=y<0?game.maps.length/game.mapWorldWidth-1:y;toIndex=y*game.mapWorldWidth+mwx;dir="north"}if(y===map.h-1){var y=mwy+1;y=y>=game.maps.length/game.mapWorldWidth?0:y;toIndex=y*game.mapWorldWidth+mwx;dir="south"}return[{mi:toIndex,dir:dir||"",x:ox===undefined?x:ox,y:oy===undefined?y:oy}]}};var getToMap=function(game){var toMap={};var pCell=api.getPlayerCell(game);var map=game.maps[game.mapIndex];var options=toMap.options=getToIndexOptions(game,pCell.x,pCell.y);options=options.map(function(opt){if(opt.dir==="north"){opt.y=map.h-1}if(opt.dir==="south"){opt.y=0}if(opt.dir==="east"){opt.x=0}if(opt.dir==="west"){opt.x=map.w-1}return opt});toMap.index=options[0].mi;toMap.x=options[0].x;toMap.y=options[0].y;return toMap};var getMovePath=function(game,startCell,targetCell){var map=game.maps[game.mapIndex],unit=startCell.unit||null;var path=mapMod.getPath(map,startCell.x,startCell.y,targetCell.x,targetCell.y);if(unit){path=path.reverse().slice(0,unit.maxCellsPerTurn)}return path};var getMoveCells=function(game,startCell,targetCell){var map=game.maps[game.mapIndex];return getMovePath(game,startCell,targetCell).map(function(pos){var cell=mapMod.get(map,pos[0],pos[1]);return cell.i})};var getEnemeyMoveCells=function(game,eCell){var pCell=api.getPlayerCell(game),map=game.maps[game.mapIndex];var pCellNeighbors=mapMod.getNeighbors(map,pCell).filter(function(cell){return cell.walkable});var mtcOptions=pCellNeighbors.map(function(cell){return getMoveCells(game,eCell,cell)}).filter(function(mtcOptions){return mtcOptions.length>0});return mtcOptions[0]||[]};var placeUnit=function(game,unit,x,y){var map=game.maps[game.mapIndex];var newCell=mapMod.get(map,x,y);if(newCell){if(unit.currentCellIndex!=null){var oldCell=map.cells[unit.currentCellIndex];oldCell.walkable=true;map.cells[unit.currentCellIndex].unit=null}newCell.walkable=false;unit.currentCellIndex=newCell.i;map.cells[unit.currentCellIndex].unit=unit}};var placePlayer=function(game){var map=game.maps[game.mapIndex],toMap=game.toMap,toCell=null,i=map.cells.length;if(toMap.x!=null&&toMap.y!=null){toCell=mapMod.get(map,toMap.x,toMap.y)}if(toCell){if(!toCell.unit){placeUnit(game,game.player,toCell.x,toCell.y);game.toMap=getToMap(game);return}}while(i--){var cell=map.cells[i];if(cell.unit===null){placeUnit(game,game.player,cell.x,cell.y);game.toMap=getToMap(game);return}}};var moveUnit=function(game,unit){if(unit.moveCells.length>0){var ci=unit.moveCells.shift();var moveToCell=mapMod.get(game.maps[game.mapIndex],ci);if(!moveToCell.unit){placeUnit(game,unit,moveToCell.x,moveToCell.y)}if(unit.type==="player"){game.toMap=getToMap(game)}}};var getCellsByUnitType=function(map,type){return map.cells.reduce(function(acc,cell){if(cell.unit){if(cell.unit.type===type){acc.push(cell)}}return acc},[])};var changeMap=function(game){var pCell=api.getPlayerCell(game);game.mapIndex=game.toMap.index;pCell.unit=null;pCell.walkable=true;game.player.currentCellIndex=null;placePlayer(game);game.toMap=getToMap(game)};var setupGame=api.setupGame=function(game,newGame){newGame=newGame===undefined?true:newGame;var playerPlaced=false,startMapIndex=0;game.mapIndex=0;game.player.HP=game.player.maxHP;if(newGame){game.remainingEnemies=0}game.mode="map";game.maps=game.maps.map(function(map,mi){var mapStr=game.mapStrings[mi]||"";game.mapIndex=mi;map.cells=map.cells.map(function(cell,ci){var cellIndex=parseInt(mapStr[ci]||"0"),x=ci%map.w,y=Math.floor(ci/map.w);if(cellIndex===0&&newGame){var cell=mapMod.get(map,ci);cell.unit=null;cell.walkable=true}if(cellIndex===1){var wall=unitMod.createUnit("wall");placeUnit(game,wall,x,y)}if(cellIndex===2){playerPlaced=true;startMapIndex=mi;placeUnit(game,game.player,x,y)}if(cellIndex===3&&newGame){game.remainingEnemies+=1;var enemy=unitMod.createUnit("enemy");enemy.HP=enemy.maxHP;placeUnit(game,enemy,x,y)}return cell});return map});if(!playerPlaced){placePlayer(game)}game.mapIndex=startMapIndex;game.toMap=getToMap(game)};var menuPool={count:8,disableLifespan:true,data:{outerRadius:75,innerRadius:25,outerTotal:1,frame:0,maxFrame:15,activeButton:null,mode:"enter"}};menuPool.spawn=function(button,options,sm,spawnOpt){var bd=button.data,pd=options.data;bd.desc=spawnOpt.desc||false;bd.cx=button.x=sm.canvas.width/2-button.w/2;bd.cy=button.y=sm.canvas.height/2-button.h/2;bd.radius=0;bd.a=0;bd.ta=spawnOpt.ta===undefined?Math.PI*2:spawnOpt.ta;bd.outer=spawnOpt.outer===undefined?true:spawnOpt.outer;bd.onClick=spawnOpt.onClick||function(){};pd.frame=0;pd.outerTotal=spawnOpt.outerTotal===undefined?1:spawnOpt.outerTotal};menuPool.update=function(button,options,sm,secs){var pd=options.data,bd=button.data;if(button.i===options.objects.length-1){if(pd.mode==="enter"){pd.frame+=30*secs;pd.frame=pd.frame>=pd.maxFrame?pd.maxFrame:pd.frame}if(pd.mode==="exit"){pd.frame-=30*secs;pd.frame=pd.frame<0?0:pd.frame;if(pd.frame===0&&pd.activeButton){pd.activeButton.data.onClick.call(sm,sm,pd.activeButton)}}}var per=pd.frame/pd.maxFrame;var radius=bd.outer?pd.outerRadius:pd.innerRadius;bd.a=bd.ta*per;button.x=bd.cx+Math.cos(bd.a)*radius*per;button.y=bd.cy+Math.sin(bd.a)*radius*per};api.create=function(opt){opt=opt||{};var game={mode:"map",turn:0,turnState:"wait",maps:[],mapIndex:0,mapWorldWidth:3,toMap:{index:null,x:null,y:null},mapStrings:opt.maps||["2"],player:unitMod.createUnit("player"),remainingEnemies:0,options:new poolMod.create(menuPool),pointerDownTime:new Date};game.mapStrings.forEach(function(){game.maps.push(mapMod.create({marginX:opt.marginX===undefined?32:opt.marginX,marginY:opt.marginY===undefined?32:opt.marginY,w:opt.w===undefined?4:opt.w,h:opt.h===undefined?4:opt.h}))});setupGame(game,true);return game};var processMeele=function(game,unit){var targetCellIndex=unit.meleeTarget,map=game.maps[game.mapIndex];if(targetCellIndex!=null){var targetCell=mapMod.get(map,targetCellIndex),tUnit=targetCell.unit;if(tUnit){unitMod.meleeAttack(unit,tUnit);if(tUnit.HP<=0&&tUnit.type==="enemy"){targetCell.walkable=true;targetCell.unit=null}}unit.meleeTarget=null}};var getRemainingEnemies=function(game){return game.maps.reduce(function(acc,map){var eCells=getCellsByUnitType(map,"enemy");return acc+eCells.length},0)};var processTurn=function(game,secs){var map=game.maps[game.mapIndex],pCell=api.getPlayerCell(game),eCells=getCellsByUnitType(map,"enemy");if(game.turnState==="wait"){return}if(game.turnState==="start"){eCells.forEach(function(eCell){var d=utils.distance(eCell.x+16,eCell.y+16,pCell.x+16,pCell.y+16);if(d<=1.5){eCell.unit.meleeTarget=pCell.i}else{eCell.unit.moveCells=getEnemeyMoveCells(game,eCell)}});game.turnState="move"}if(game.turnState==="move"){moveUnit(game,game.player);eCells.forEach(function(eCell){moveUnit(game,eCell.unit)});var eCells=getCellsByUnitType(map,"enemy");if(game.player.moveCells.length===0&&eCells.every(function(eCell){return eCell.unit.moveCells.length===0})){game.turnState="melee"}}if(game.turnState==="melee"){processMeele(game,game.player);var eCells=getCellsByUnitType(map,"enemy");eCells.forEach(function(eCell){processMeele(game,eCell.unit)});game.turnState="end"}if(game.turnState==="end"){game.turn+=1;game.turnState="wait";if(game.player.HP<=0){pCell.unit=null;pCell.walkable=true;setupGame(game,false)}game.remainingEnemies=getRemainingEnemies(game);if(game.remainingEnemies===0){setupGame(game,true)}}};api.update=function(sm,secs){var game=sm.game;if(game.mode==="map"){processTurn(game,secs)}if(game.mode==="menu"){poolMod.update(game.options,secs,sm)}};api.getPlayerCell=function(game){var p=game.player,map=game.maps[game.mapIndex];return map.cells[p.currentCellIndex]};api.pointerStart=function(sm,x,y){var game=sm.game;game.pointerDownTime=new Date};var BUTTON={};BUTTON.quit={desc:"quit",outer:true,onClick:function(sm,button){sm.setState("title")}};BUTTON.resume={desc:"resume",outer:true,onClick:function(sm,button){sm.game.mode="map"}};var createMapButtonOnClick=function(dir){return function(sm,button){var tm=sm.game.toMap;sm.game.mode="map";tm.options.forEach(function(opt){if(opt.dir===dir){tm.index=opt.mi;tm.x=opt.x;tm.y=opt.y}});changeMap(sm.game)}};BUTTON.map_south={desc:"South",outer:false,ta:Math.PI*.5,onClick:createMapButtonOnClick("south")};BUTTON.map_north={desc:"North",outer:false,ta:Math.PI*1.5,onClick:createMapButtonOnClick("north")};BUTTON.map_east={desc:"East",outer:false,ta:Math.PI*2,onClick:createMapButtonOnClick("east")};BUTTON.map_west={desc:"West",outer:false,ta:Math.PI*1,onClick:createMapButtonOnClick("west")};BUTTON.dum1={desc:"dummy1",outer:true,onClick:function(sm,button){sm.game.mode="map"}};BUTTON.dum2={desc:"dummy2",outer:false,onClick:function(sm,button){sm.game.mode="map"}};BUTTON.dum3={desc:"dummy2",outer:false,onClick:function(sm,button){sm.game.mode="map"}};var getButtonKeyValueCount=function(buttonKeys,prop,value){return buttonKeys.reduce(function(acc,buttonKey){var buttonDATA=BUTTON[buttonKey];if(buttonDATA[prop]===value){acc+=1}return acc},0)};var createMenu=function(game){game.options.objects.forEach(function(button){button.active=false});var buttonKeys=["quit","resume"];buttonKeys=buttonKeys.concat(game.toMap.options.map(function(opt){return"map_"+opt.dir}));var oi=0,ii=0,oc=getButtonKeyValueCount(buttonKeys,"outer",true),ic=getButtonKeyValueCount(buttonKeys,"outer",false);buttonKeys.forEach(function(buttonKey){var buttonDATA=BUTTON[buttonKey],len=buttonDATA.outer?oc:ic,i=buttonDATA.outer?oi:ii,ta=Math.PI*2/len*(i+1);ta=buttonDATA.ta!=undefined?buttonDATA.ta:ta;poolMod.spawn(game.options,sm,{desc:buttonDATA.desc,onClick:buttonDATA.onClick,outer:buttonDATA.outer,ta:ta});if(buttonDATA.outer){oi+=1}else{ii+=1}})};api.pointerEnd=function(sm,x,y){var game=sm.game,now=new Date,clickedCell=mapMod.getCellByPointer(game.maps[game.mapIndex],x,y),map=game.maps[game.mapIndex],pCell=api.getPlayerCell(game);secs=(now-game.pointerDownTime)/1e3;if(secs>=.5){console.log("long press!");if(game.mode==="map"){game.mode="menu";game.options.data.mode="enter";createMenu(game)}}if(secs<.5){if(game.mode==="map"&&clickedCell){if(clickedCell===pCell&&game.toMap.index!=null){if(game.toMap.options.length>1){game.mode="menu";game.options.data.mode="enter";createMenu(game)}else{changeMap(game)}return}if(clickedCell.unit){var unit=clickedCell.unit;if(unit.type==="enemy"){game.player.meleeTarget=clickedCell.i;game.turnState="start";return}}game.player.moveCells=getMoveCells(game,pCell,clickedCell);game.turnState="start"}if(game.mode==="menu"){var clicked=poolMod.getOverlaping({active:true,w:1,h:1,x:x,y:y},game.options);if(clicked.length>=1){game.options.data.mode="exit";game.options.data.activeButton=clicked[0]}else{game.mode="map"}}}};return api}();var draw=function(){var api={};var unitColors=["green","gray","blue","red"];var drawHPBar=function(sm,cell){var unit=cell.unit;var ctx=sm.ctx;var map=sm.game.maps[sm.game.mapIndex];var cs=map.cellSize;var x=map.margin.x+cell.x*cs;var y=map.margin.y+cell.y*cs;if(unit){if(unit.type=="player"||unit.type==="enemy"){ctx.fillStyle="gray";ctx.beginPath();ctx.rect(x,y,cs,5);ctx.fill();ctx.stroke();var per=unit.HP/unit.maxHP;ctx.fillStyle="lime";ctx.beginPath();ctx.rect(x,y,cs*per,5);ctx.fill();ctx.stroke()}}};var drawCell=function(sm,cell){var map=sm.game.maps[sm.game.mapIndex];var ctx=sm.ctx;var cs=map.cellSize;var x=map.margin.x+cell.x*cs;var y=map.margin.y+cell.y*cs;ctx.fillStyle=unitColors[0];if(cell.unit){ctx.fillStyle=unitColors[cell.unit.sheetIndex]}ctx.beginPath();ctx.rect(x,y,cs,cs);ctx.fill();ctx.stroke();drawHPBar(sm,cell)};api.back=function(sm,style){var canvas=sm.canvas,ctx=sm.ctx;ctx.fillStyle=style||"black";ctx.fillRect(0,0,canvas.width,canvas.height)};api.options=function(sm){var canvas=sm.canvas,pool=sm.game.options,ctx=sm.ctx,opt={};pool.objects.forEach(function(obj){ctx.fillStyle=opt.fillStyle||obj.data.fillStyle||"white";ctx.strokeStyle=opt.strokeStyle||obj.data.strokeStyle||"black";if(obj.active||opt.drawAll){var cx=obj.x+obj.w/2,cy=obj.y+obj.h/2;ctx.beginPath();ctx.arc(cx,cy,(obj.w+obj.h)/2/2,0,Math.PI*2);ctx.fill();ctx.stroke();if(obj.data.desc){ctx.fillStyle="black";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(obj.data.desc,cx,cy)}}})};api.titleText=function(sm){var canvas=sm.canvas,ctx=sm.ctx;ctx.fillStyle="white";ctx.font="20px courier";ctx.textBaseline="top";ctx.textAlign="center";var x=canvas.width/2,y=canvas.height*.25;ctx.fillText("Turn Based RPG Prototype",x,y)};api.map=function(sm){var map=sm.game.maps[sm.game.mapIndex],i=0,len=map.cells.length;while(i<len){drawCell(sm,map.cells[i]);i+=1}};api.ver=function(sm,style){var ctx=sm.ctx,canvas=sm.canvas;ctx.fillStyle=style||"white";ctx.font="8px courier";ctx.textBaseline="top";ctx.textAlign="left";ctx.fillText("v"+sm.ver,1,canvas.height-10)};api.info=function(sm){var ctx=sm.ctx,pos=sm.input.pos,pCell=gameMod.getPlayerCell(sm.game),canvas=sm.canvas,dy=12;ctx.fillStyle="yellow";ctx.font="10px courier";ctx.textBaseline="top";ctx.textAlign="left";ctx.fillText("pos: "+pos.x+","+pos.y,5,5+dy*0);ctx.fillText("player pos: "+pCell.x+","+pCell.y,5,5+dy*1);var tm=sm.game.toMap;ctx.fillText("toMap: mi:"+tm.index+", x: "+tm.x+", y: "+tm.y,5,5+dy*2);ctx.fillText("toMap.options:"+JSON.stringify(tm.options.map(function(opt){return opt.dir+"("+opt.x+","+opt.y+");"+opt.mi})),5,5+dy*3);ctx.fillText("turn:"+sm.game.turn+", turnState: "+sm.game.turnState,5,5+dy*4);ctx.fillText("enemies:"+sm.game.remainingEnemies,5,5+dy*5)};return api}();var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),container=document.getElementById("canvas-app")||document.body;container.appendChild(canvas);canvas.width=320;canvas.height=240;canvas.className="canvas-layer";ctx.translate(.5,.5);canvas.onselectstart=function(){return false};var sm={ver:"0.5.0",fps:12,lt:new Date,states:{},stateObj:null,currentState:"",game:gameMod.create({marginX:14,marginY:7,w:9,h:7,maps:["111111111"+"100000000"+"103030000"+"100000000"+"100000000"+"100000000"+"100000001","111111111"+"000000000"+"000000300"+"000000000"+"000000000"+"000000000"+"100100000","111111111"+"000000001"+"000000301"+"000000001"+"000000301"+"000000001"+"000000301","100000001"+"103000001"+"100000000"+"100000001"+"100000001"+"103000001"+"100000001","100100000"+"100111010"+"000001010"+"100101030"+"100100111"+"100100200"+"100100000","000000001"+"000000001"+"000000031"+"000111111"+"111100031"+"000000001"+"000000001","100000001"+"100000001"+"100000001"+"103000000"+"100000000"+"103030000"+"111111111","100100000"+"100000000"+"100000000"+"000000000"+"000000000"+"000000300"+"111111111","000000001"+"000000001"+"000000001"+"000000301"+"000000001"+"000000301"+"111111111"]}),canvas:canvas,ctx:ctx,input:{pointerDown:false,pos:{x:0,y:0}}};sm.setState=function(newStateKey){sm.currentState=newStateKey;sm.stateObj=sm.states[sm.currentState]};sm.callStateEvent=function(eventKey,e,opt){if(sm.stateObj){var events=sm.stateObj.events;if(events){if(events[eventKey]){events[eventKey].call(sm,e,opt,sm)}}}};var pointerHanders={start:function(sm,e){var pos=sm.input.pos=utils.getCanvasRelative(e);if(e.type==="touchstart"){e.preventDefault()}sm.input.pointerDown=true;sm.callStateEvent("pointerStart",e,pos)},move:function(sm,e){var pos=sm.input.pos=utils.getCanvasRelative(e);sm.callStateEvent("pointerMove",e,pos)},end:function(sm,e){sm.input.pointerDown=false;sm.callStateEvent("pointerEnd",e,sm.input.pos)}};var createPointerHandler=function(sm,type){return function(e){pointerHanders[type](sm,e)}};canvas.addEventListener("touchstart",createPointerHandler(sm,"start"));canvas.addEventListener("touchmove",createPointerHandler(sm,"move"));canvas.addEventListener("touchend",createPointerHandler(sm,"end"));canvas.addEventListener("mousedown",createPointerHandler(sm,"start"));canvas.addEventListener("mousemove",createPointerHandler(sm,"move"));canvas.addEventListener("mouseup",createPointerHandler(sm,"end"));sm.states.title={key:"title",update:function(sm,secs){},draw:function(sm,layers){draw.back(sm);draw.titleText(sm);draw.ver(sm)},events:{pointerEnd:function(e,pos,sm){gameMod.setupGame(sm.game,true);sm.setState("game")}}};sm.states.game={key:"game",update:function(sm,secs){gameMod.update(sm,secs)},draw:function(sm,layers){draw.back(sm);draw.map(sm);if(sm.game.mode==="map"){draw.info(sm)}if(sm.game.mode==="menu"){draw.back(sm,"rgba(0,0,0,0.5)");draw.options(sm)}draw.ver(sm)},events:{pointerStart:function(e,pos,sm){gameMod.pointerStart(sm,pos.x,pos.y)},pointerEnd:function(e,pos,sm){gameMod.pointerEnd(sm,pos.x,pos.y)}}};sm.setState("game");var loop=function(){var now=new Date,secs=(now-sm.lt)/1e3;requestAnimationFrame(loop);if(secs>=1/sm.fps){sm.stateObj.update.call(sm,sm,secs);sm.stateObj.draw.call(sm,sm,{});sm.lt=now}};loop();
</script>

</body></html>
