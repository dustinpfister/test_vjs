<html><head><title>javascript-example-grid-game-unit-movement</title></head><body> 

<div id="canvas-app"style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div>
<script>var utils={};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.angleToPoint=function(x1,y1,x2,y2,scale){scale=scale===undefined?Math.PI*2:scale;var aTan=Math.atan2(y1-y2,x1-x2);return(aTan+Math.PI)/(Math.PI*2)*scale};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect();return{x:(e.touches?e.touches[0].clientX:e.clientX)-bx.left,y:(e.touches?e.touches[0].clientY:e.clientY)-bx.top,bx:bx}};utils.deepCloneJSON=function(obj){return JSON.parse(JSON.stringify(obj))};utils.isCircularObject=function(node,parents){parents=parents||[];if(!node||typeof node!="object"){return false}var keys=Object.keys(node),i,value;parents.push(node);for(i=keys.length-1;i>=0;i--){value=node[keys[i]];if(value&&typeof value=="object"){if(parents.indexOf(value)>=0){return true}if(arguments.callee(value,parents)){return true}}}parents.pop(node);return false};utils.deepClone=function(){var forInstance={Date:function(val,key,opt){return new Date(val.getTime())},Array:function(val,key,opt){var obj=utils.deepClone(val,opt);obj.length=Object.keys(obj).length;return Array.from(obj)},Object:function(val,key,opt){return utils.deepClone(val,opt)}};var forRecursive=function(cloneObj,sourceObj,sourceKey){return cloneObj};var forUnsupported=function(cloneObj,sourceObj,sourceKey){return sourceObj[sourceKey]};return function(obj,opt){var clone={},conName,forIMethod;opt=opt||{};opt.forInstance=opt.forInstance||{};opt.forRecursive=opt.forRecursive||forRecursive;opt.forUnsupported=opt.forUnsupported||forUnsupported;for(var i in obj){if(typeof obj[i]=="object"&&obj[i]!=null){if(obj[i]===obj){clone[i]=opt.forRecursive(clone,obj,i)}else{conName=obj[i].constructor.name;forIMethod=opt.forInstance[conName]||forInstance[conName];if(forIMethod){clone[i]=forIMethod(obj[i],i,opt)}else{clone[i]=opt.forUnsupported(clone,obj,i)}}}else{clone[i]=obj[i]}}return clone}}();var mapMod=function(){var createCells=function(map){var cells=[];var len=map.w*map.h,i=0;while(i<len){cells.push({i:i,x:i%map.w,y:Math.floor(i/map.w),walkable:true,closed:false,data:{},unit:null});i+=1}return cells};var api={};api.create=function(opt){opt=opt||{};var map={w:opt.w||9,h:opt.h||7,cellSize:32,margin:{x:opt.marginX==undefined?5:opt.marginX,y:opt.marginY==undefined?5:opt.marginY},cells:[]};map.cells=opt.cells||createCells(map);return map};api.get=function(map,x,y){if(x<0||y<0||x>=map.w||y>=map.h){return false}return map.cells[y*map.w+x]};api.getCellByPointer=function(map,x,y){var cx=Math.floor((x-map.margin.x)/map.cellSize),cy=Math.floor((y-map.margin.y)/map.cellSize);return api.get(map,cx,cy)};var sortOpen=function(opened){return opened.sort(function(nodeA,nodeB){if(nodeA.weight<nodeB.weight){return 1}if(nodeA.weight>nodeB.weight){return-1}return 0})};var setWeight=function(endNode,neighbor){return utils.distance(endNode.x,endNode.y,neighbor.x,neighbor.y)};var buildPath=function(node){var path=[];while(node.parent){path.push([node.x,node.y]);node=node.parent}return path};var forNeighbors=function(grid,node,endNode,opened){var neighbors=mapMod.getNeighbors(grid,node);var ni=0,nl=neighbors.length;while(ni<nl){var neighbor=neighbors[ni];if(neighbor.closed){ni+=1;continue}neighbor.weight=setWeight(endNode,neighbor);if(!neighbor.opened){neighbor.parent=node;opened.push(neighbor);neighbor.opened=true}ni+=1}};api.getPath=function(grid,sx,sy,ex,ey){var grid=utils.deepCloneJSON(grid),nodes=api.chunk(grid),path=[],opened=[],node;var startNode=nodes[sy][sx];endNode=nodes[ey][ex];opened.push(startNode);startNode.opened=true;startNode.weight=0;while(opened.length>0){node=opened.pop();node.closed=true;if(node===endNode){return buildPath(node)}forNeighbors(grid,node,endNode,opened);sortOpen(opened)}return[]};api.chunk=function(grid){var arr=[],row,i=0;while(i<grid.cells.length){row=grid.cells.slice(i,i+grid.w);arr.push(row);i+=grid.w}return arr};api.isInBounds=function(grid,x,y){return x>=0&&x<grid.w&&(y>=0&&y<grid.h)};api.isWalkable=function(grid,x,y){if(api.isInBounds(grid,x,y)){return api.get(grid,x,y).walkable}return false};api.getNeighbors=function(grid,node){var x=node.x,y=node.y,neighbors=[];if(api.isWalkable(grid,x,y-1)){neighbors.push(mapMod.get(grid,x,y-1))}if(api.isWalkable(grid,x,y+1)){neighbors.push(mapMod.get(grid,x,y+1))}if(api.isWalkable(grid,x-1,y)){neighbors.push(mapMod.get(grid,x-1,y))}if(api.isWalkable(grid,x+1,y)){neighbors.push(mapMod.get(grid,x+1,y))}return neighbors};return api}();var gameMod=function(){var createBaseUnit=function(){return{HP:100,maxHP:100,weaponIndex:0,sheetIndex:0,currentCellIndex:null,active:false}};var createPlayerUnit=function(){var player=createBaseUnit();player.active=true;player.sheetIndex=2;return player};var createWallUnit=function(){var wall=createBaseUnit();wall.active=true;wall.sheetIndex=1;return wall};var placeUnit=function(game,unit,x,y){var map=game.maps[game.mapIndex];var newCell=mapMod.get(map,x,y);if(newCell){if(unit.currentCellIndex!=null){var oldCell=map.cells[unit.currentCellIndex];oldCell.walkable=true;map.cells[unit.currentCellIndex].unit=null}newCell.walkable=false;unit.currentCellIndex=newCell.i;map.cells[unit.currentCellIndex].unit=unit}};var setupGame=function(game,mapStrings){game.mapIndex=0;game.maps=game.maps.map(function(map,mi){var mapStr=mapStrings[mi]||"";map.cells=map.cells.map(function(cell,ci){var cellIndex=parseInt(mapStr[ci]||"0"),x=ci%map.w,y=Math.floor(ci/map.w);if(cellIndex===1){var wall=createWallUnit();placeUnit(game,wall,x,y)}if(cellIndex===2){placeUnit(game,game.player,x,y)}return cell});return map})};var api={};api.create=function(opt){opt=opt||{};var game={mode:"map",maps:[],mapIndex:0,targetCell:false,player:createPlayerUnit()};game.maps.push(mapMod.create({marginX:opt.marginX===undefined?32:opt.marginX,marginY:opt.marginY===undefined?32:opt.marginY,w:opt.w===undefined?4:opt.w,h:opt.h===undefined?4:opt.h}));setupGame(game,opt.maps||["2"]);return game};api.update=function(game,secs){var cell,radian,target;if(target=game.targetCell){cell=game.maps[game.mapIndex].cells[game.player.currentCellIndex];if(target!=cell){radian=utils.angleToPoint(cell.x,cell.y,target.x,target.y);var cx=Math.round(cell.x+Math.cos(radian)),cy=Math.round(cell.y+Math.sin(radian));placeUnit(game,game.player,cx,cy);game.targetCell=false}}};api.getPlayerCell=function(game){var p=game.player,map=game.maps[game.mapIndex];return map.cells[p.currentCellIndex]};api.playerPointer=function(game,x,y){var cell=mapMod.getCellByPointer(game.maps[game.mapIndex],x,y),map=game.maps[game.mapIndex];if(cell){var pCell=api.getPlayerCell(game),path=mapMod.getPath(map,pCell.x,pCell.y,cell.x,cell.y),pos=path.pop();if(pos){var tCell=mapMod.get(map,pos[0],pos[1]);game.targetCell=tCell}}};return api}();var draw=function(){var unitColors=["green","gray","blue","red"];return{back:function(sm){var canvas=sm.canvas,ctx=sm.ctx;ctx.fillStyle="black";ctx.fillRect(0,0,canvas.width,canvas.height)},map:function(sm){var canvas=sm.canvas,ctx=sm.ctx,map=sm.game.maps[sm.game.mapIndex];var cs=map.cellSize,i=0,x,y,len=map.cells.length,cell;while(i<len){cell=map.cells[i];x=map.margin.x+cell.x*cs;y=map.margin.y+cell.y*cs;ctx.fillStyle="green";if(!cell.walkable){ctx.fillStyle="gray"}if(cell.unit){ctx.fillStyle=unitColors[cell.unit.sheetIndex]}ctx.beginPath();ctx.rect(x,y,32,32);ctx.fill();ctx.stroke();i+=1}},info:function(sm){var ctx=sm.ctx,pos=sm.input.pos,pCell=gameMod.getPlayerCell(sm.game),canvas=sm.canvas;ctx.fillStyle="white";ctx.font="10px courier";ctx.textBaseline="top";ctx.fillText("pos: "+pos.x+","+pos.y,5,5);ctx.fillText("player pos: "+pCell.x+","+pCell.y,5,15);ctx.fillText("v"+sm.ver,1,canvas.height-11)}}}();(function(){var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),container=document.getElementById("canvas-app")||document.body;container.appendChild(canvas);canvas.width=320;canvas.height=240;ctx.translate(.5,.5);canvas.onselectstart=function(){return false};var sm={ver:"0.3.0",fps:12,lt:new Date,game:gameMod.create({marginX:14,marginY:7,w:9,h:7,maps:["000100000000111100000001000020101000000100100000100000000100000"]}),canvas:canvas,ctx:ctx,input:{pointerDown:false,pos:{x:0,y:0}}};var pointerHanders={start:function(sm,e){var pos=sm.input.pos=utils.getCanvasRelative(e);if(e.type==="touchstart"){e.preventDefault()}sm.input.pointerDown=true;gameMod.playerPointer(sm.game,pos.x,pos.y)},move:function(sm,e){sm.input.pos=utils.getCanvasRelative(e)},end:function(sm,e){sm.input.pointerDown=false}};var createPointerHandler=function(sm,type){return function(e){pointerHanders[type](sm,e)}};canvas.addEventListener("touchstart",createPointerHandler(sm,"start"));canvas.addEventListener("touchmove",createPointerHandler(sm,"move"));canvas.addEventListener("touchend",createPointerHandler(sm,"end"));canvas.addEventListener("mousedown",createPointerHandler(sm,"start"));canvas.addEventListener("mousemove",createPointerHandler(sm,"move"));canvas.addEventListener("mouseup",createPointerHandler(sm,"end"));var loop=function(){var now=new Date,secs=(now-sm.lt)/1e3;requestAnimationFrame(loop);if(secs>=1/sm.fps){gameMod.update(sm.game);draw.back(sm);draw.map(sm);draw.info(sm);sm.lt=now}};loop()})();
</script>

</body></html>
